<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>nbdev-sqlite-utils - sqlite_utils Python library</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="nbdev-sqlite-utils - sqlite_utils Python library">
<meta property="og:description" content="Note: the notebook does not currently execute end-to-end due to issue #235.">
<meta property="og:site-name" content="nbdev-sqlite-utils">
<meta name="twitter:title" content="nbdev-sqlite-utils - sqlite_utils Python library">
<meta name="twitter:description" content="Note: the notebook does not currently execute end-to-end due to issue #235.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">nbdev-sqlite-utils</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">sqlite_utils Python library</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">nbdev-sqlite-utils</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python-api.html" class="sidebar-item-text sidebar-link active">sqlite_utils Python library</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rst2ipynb.html" class="sidebar-item-text sidebar-link">rst2ipynb</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link active" data-scroll-target="#getting-started">Getting started</a></li>
  <li><a href="#connecting-to-or-creating-a-database" id="toc-connecting-to-or-creating-a-database" class="nav-link" data-scroll-target="#connecting-to-or-creating-a-database">Connecting to or creating a database</a>
  <ul class="collapse">
  <li><a href="#attaching-additional-databases" id="toc-attaching-additional-databases" class="nav-link" data-scroll-target="#attaching-additional-databases">Attaching additional databases</a></li>
  <li><a href="#tracing-queries" id="toc-tracing-queries" class="nav-link" data-scroll-target="#tracing-queries">Tracing queries</a></li>
  </ul></li>
  <li><a href="#executing-queries" id="toc-executing-queries" class="nav-link" data-scroll-target="#executing-queries">Executing queries</a>
  <ul class="collapse">
  <li><a href="#db.querysql-params" id="toc-db.querysql-params" class="nav-link" data-scroll-target="#db.querysql-params">db.query(sql, params)</a></li>
  <li><a href="#db.executesql-params" id="toc-db.executesql-params" class="nav-link" data-scroll-target="#db.executesql-params">db.execute(sql, params)</a></li>
  <li><a href="#passing-parameters" id="toc-passing-parameters" class="nav-link" data-scroll-target="#passing-parameters">Passing parameters</a></li>
  </ul></li>
  <li><a href="#accessing-tables" id="toc-accessing-tables" class="nav-link" data-scroll-target="#accessing-tables">Accessing tables</a></li>
  <li><a href="#listing-tables" id="toc-listing-tables" class="nav-link" data-scroll-target="#listing-tables">Listing tables</a></li>
  <li><a href="#listing-views" id="toc-listing-views" class="nav-link" data-scroll-target="#listing-views">Listing views</a></li>
  <li><a href="#listing-rows" id="toc-listing-rows" class="nav-link" data-scroll-target="#listing-rows">Listing rows</a>
  <ul class="collapse">
  <li><a href="#counting-rows" id="toc-counting-rows" class="nav-link" data-scroll-target="#counting-rows">Counting rows</a></li>
  </ul></li>
  <li><a href="#listing-rows-with-their-primary-keys" id="toc-listing-rows-with-their-primary-keys" class="nav-link" data-scroll-target="#listing-rows-with-their-primary-keys">Listing rows with their primary keys</a></li>
  <li><a href="#retrieving-a-specific-record" id="toc-retrieving-a-specific-record" class="nav-link" data-scroll-target="#retrieving-a-specific-record">Retrieving a specific record</a></li>
  <li><a href="#showing-the-schema" id="toc-showing-the-schema" class="nav-link" data-scroll-target="#showing-the-schema">Showing the schema</a></li>
  <li><a href="#creating-tables" id="toc-creating-tables" class="nav-link" data-scroll-target="#creating-tables">Creating tables</a>
  <ul class="collapse">
  <li><a href="#custom-column-order-and-column-types" id="toc-custom-column-order-and-column-types" class="nav-link" data-scroll-target="#custom-column-order-and-column-types">Custom column order and column types</a></li>
  <li><a href="#explicitly-creating-a-table" id="toc-explicitly-creating-a-table" class="nav-link" data-scroll-target="#explicitly-creating-a-table">Explicitly creating a table</a></li>
  <li><a href="#compound-primary-keys" id="toc-compound-primary-keys" class="nav-link" data-scroll-target="#compound-primary-keys">Compound primary keys</a></li>
  <li><a href="#specifying-foreign-keys" id="toc-specifying-foreign-keys" class="nav-link" data-scroll-target="#specifying-foreign-keys">Specifying foreign keys</a></li>
  </ul></li>
  <li><a href="#table-configuration-options" id="toc-table-configuration-options" class="nav-link" data-scroll-target="#table-configuration-options">Table configuration options</a></li>
  <li><a href="#setting-defaults-and-not-null-constraints" id="toc-setting-defaults-and-not-null-constraints" class="nav-link" data-scroll-target="#setting-defaults-and-not-null-constraints">Setting defaults and not null constraints</a></li>
  <li><a href="#duplicating-tables" id="toc-duplicating-tables" class="nav-link" data-scroll-target="#duplicating-tables">Duplicating tables</a></li>
  <li><a href="#bulk-inserts" id="toc-bulk-inserts" class="nav-link" data-scroll-target="#bulk-inserts">Bulk inserts</a></li>
  <li><a href="#insert-replacing-data" id="toc-insert-replacing-data" class="nav-link" data-scroll-target="#insert-replacing-data">Insert-replacing data</a></li>
  <li><a href="#updating-a-specific-record" id="toc-updating-a-specific-record" class="nav-link" data-scroll-target="#updating-a-specific-record">Updating a specific record</a></li>
  <li><a href="#deleting-a-specific-record" id="toc-deleting-a-specific-record" class="nav-link" data-scroll-target="#deleting-a-specific-record">Deleting a specific record</a></li>
  <li><a href="#deleting-multiple-records" id="toc-deleting-multiple-records" class="nav-link" data-scroll-target="#deleting-multiple-records">Deleting multiple records</a></li>
  <li><a href="#upserting-data" id="toc-upserting-data" class="nav-link" data-scroll-target="#upserting-data">Upserting data</a></li>
  <li><a href="#converting-data-in-columns" id="toc-converting-data-in-columns" class="nav-link" data-scroll-target="#converting-data-in-columns">Converting data in columns</a></li>
  <li><a href="#working-with-lookup-tables" id="toc-working-with-lookup-tables" class="nav-link" data-scroll-target="#working-with-lookup-tables">Working with lookup tables</a>
  <ul class="collapse">
  <li><a href="#creating-lookup-tables-explicitly" id="toc-creating-lookup-tables-explicitly" class="nav-link" data-scroll-target="#creating-lookup-tables-explicitly">Creating lookup tables explicitly</a></li>
  <li><a href="#populating-lookup-tables-automatically-during-insertupsert" id="toc-populating-lookup-tables-automatically-during-insertupsert" class="nav-link" data-scroll-target="#populating-lookup-tables-automatically-during-insertupsert">Populating lookup tables automatically during insert/upsert</a></li>
  </ul></li>
  <li><a href="#working-with-many-to-many-relationships" id="toc-working-with-many-to-many-relationships" class="nav-link" data-scroll-target="#working-with-many-to-many-relationships">Working with many-to-many relationships</a>
  <ul class="collapse">
  <li><a href="#using-m2m-and-lookup-tables-together" id="toc-using-m2m-and-lookup-tables-together" class="nav-link" data-scroll-target="#using-m2m-and-lookup-tables-together">Using m2m and lookup tables together</a></li>
  </ul></li>
  <li><a href="#analyzing-a-column" id="toc-analyzing-a-column" class="nav-link" data-scroll-target="#analyzing-a-column">Analyzing a column</a></li>
  <li><a href="#adding-columns" id="toc-adding-columns" class="nav-link" data-scroll-target="#adding-columns">Adding columns</a></li>
  <li><a href="#adding-columns-automatically-on-insertupdate" id="toc-adding-columns-automatically-on-insertupdate" class="nav-link" data-scroll-target="#adding-columns-automatically-on-insertupdate">Adding columns automatically on insert/update</a></li>
  <li><a href="#adding-foreign-key-constraints" id="toc-adding-foreign-key-constraints" class="nav-link" data-scroll-target="#adding-foreign-key-constraints">Adding foreign key constraints</a>
  <ul class="collapse">
  <li><a href="#adding-multiple-foreign-key-constraints-at-once" id="toc-adding-multiple-foreign-key-constraints-at-once" class="nav-link" data-scroll-target="#adding-multiple-foreign-key-constraints-at-once">Adding multiple foreign key constraints at once</a></li>
  <li><a href="#adding-indexes-for-all-foreign-keys" id="toc-adding-indexes-for-all-foreign-keys" class="nav-link" data-scroll-target="#adding-indexes-for-all-foreign-keys">Adding indexes for all foreign keys</a></li>
  </ul></li>
  <li><a href="#dropping-a-table-or-view" id="toc-dropping-a-table-or-view" class="nav-link" data-scroll-target="#dropping-a-table-or-view">Dropping a table or view</a></li>
  <li><a href="#transforming-a-table" id="toc-transforming-a-table" class="nav-link" data-scroll-target="#transforming-a-table">Transforming a table</a>
  <ul class="collapse">
  <li><a href="#altering-column-types" id="toc-altering-column-types" class="nav-link" data-scroll-target="#altering-column-types">Altering column types</a></li>
  <li><a href="#renaming-columns" id="toc-renaming-columns" class="nav-link" data-scroll-target="#renaming-columns">Renaming columns</a></li>
  <li><a href="#dropping-columns" id="toc-dropping-columns" class="nav-link" data-scroll-target="#dropping-columns">Dropping columns</a></li>
  <li><a href="#changing-primary-keys" id="toc-changing-primary-keys" class="nav-link" data-scroll-target="#changing-primary-keys">Changing primary keys</a></li>
  <li><a href="#changing-not-null-status" id="toc-changing-not-null-status" class="nav-link" data-scroll-target="#changing-not-null-status">Changing not null status</a></li>
  <li><a href="#altering-column-defaults" id="toc-altering-column-defaults" class="nav-link" data-scroll-target="#altering-column-defaults">Altering column defaults</a></li>
  <li><a href="#changing-column-order" id="toc-changing-column-order" class="nav-link" data-scroll-target="#changing-column-order">Changing column order</a></li>
  <li><a href="#dropping-foreign-key-constraints" id="toc-dropping-foreign-key-constraints" class="nav-link" data-scroll-target="#dropping-foreign-key-constraints">Dropping foreign key constraints</a></li>
  <li><a href="#custom-transformations-with-.transform_sql" id="toc-custom-transformations-with-.transform_sql" class="nav-link" data-scroll-target="#custom-transformations-with-.transform_sql">Custom transformations with .transform_sql()</a></li>
  </ul></li>
  <li><a href="#extracting-columns-into-a-separate-table" id="toc-extracting-columns-into-a-separate-table" class="nav-link" data-scroll-target="#extracting-columns-into-a-separate-table">Extracting columns into a separate table</a></li>
  <li><a href="#setting-an-id-based-on-the-hash-of-the-row-contents" id="toc-setting-an-id-based-on-the-hash-of-the-row-contents" class="nav-link" data-scroll-target="#setting-an-id-based-on-the-hash-of-the-row-contents">Setting an ID based on the hash of the row contents</a></li>
  <li><a href="#creating-views" id="toc-creating-views" class="nav-link" data-scroll-target="#creating-views">Creating views</a></li>
  <li><a href="#storing-json" id="toc-storing-json" class="nav-link" data-scroll-target="#storing-json">Storing JSON</a></li>
  <li><a href="#converting-column-values-using-sql-functions" id="toc-converting-column-values-using-sql-functions" class="nav-link" data-scroll-target="#converting-column-values-using-sql-functions">Converting column values using SQL functions</a></li>
  <li><a href="#checking-the-sqlite-version" id="toc-checking-the-sqlite-version" class="nav-link" data-scroll-target="#checking-the-sqlite-version">Checking the SQLite version</a></li>
  <li><a href="#introspecting-tables-and-views" id="toc-introspecting-tables-and-views" class="nav-link" data-scroll-target="#introspecting-tables-and-views">Introspecting tables and views</a>
  <ul class="collapse">
  <li><a href="#exists" id="toc-exists" class="nav-link" data-scroll-target="#exists">.exists()</a></li>
  <li><a href="#count" id="toc-count" class="nav-link" data-scroll-target="#count">.count</a></li>
  <li><a href="#columns" id="toc-columns" class="nav-link" data-scroll-target="#columns">.columns</a></li>
  <li><a href="#columns_dict" id="toc-columns_dict" class="nav-link" data-scroll-target="#columns_dict">.columns_dict</a></li>
  <li><a href="#pks" id="toc-pks" class="nav-link" data-scroll-target="#pks">.pks</a></li>
  <li><a href="#use_rowid" id="toc-use_rowid" class="nav-link" data-scroll-target="#use_rowid">.use_rowid</a></li>
  <li><a href="#foreign_keys" id="toc-foreign_keys" class="nav-link" data-scroll-target="#foreign_keys">.foreign_keys</a></li>
  <li><a href="#schema" id="toc-schema" class="nav-link" data-scroll-target="#schema">.schema</a></li>
  <li><a href="#strict" id="toc-strict" class="nav-link" data-scroll-target="#strict">.strict</a></li>
  <li><a href="#indexes" id="toc-indexes" class="nav-link" data-scroll-target="#indexes">.indexes</a></li>
  <li><a href="#xindexes" id="toc-xindexes" class="nav-link" data-scroll-target="#xindexes">.xindexes</a></li>
  <li><a href="#triggers" id="toc-triggers" class="nav-link" data-scroll-target="#triggers">.triggers</a></li>
  <li><a href="#triggers_dict" id="toc-triggers_dict" class="nav-link" data-scroll-target="#triggers_dict">.triggers_dict</a></li>
  <li><a href="#detect_fts" id="toc-detect_fts" class="nav-link" data-scroll-target="#detect_fts">.detect_fts()</a></li>
  <li><a href="#virtual_table_using" id="toc-virtual_table_using" class="nav-link" data-scroll-target="#virtual_table_using">.virtual_table_using</a></li>
  <li><a href="#has_counts_triggers" id="toc-has_counts_triggers" class="nav-link" data-scroll-target="#has_counts_triggers">.has_counts_triggers</a></li>
  </ul></li>
  <li><a href="#full-text-search" id="toc-full-text-search" class="nav-link" data-scroll-target="#full-text-search">Full-text search</a>
  <ul class="collapse">
  <li><a href="#enabling-full-text-search-for-a-table" id="toc-enabling-full-text-search-for-a-table" class="nav-link" data-scroll-target="#enabling-full-text-search-for-a-table">Enabling full-text search for a table</a></li>
  <li><a href="#quoting-characters-for-use-in-search" id="toc-quoting-characters-for-use-in-search" class="nav-link" data-scroll-target="#quoting-characters-for-use-in-search">Quoting characters for use in search</a></li>
  <li><a href="#searching-with-table.search" id="toc-searching-with-table.search" class="nav-link" data-scroll-target="#searching-with-table.search">Searching with table.search()</a></li>
  <li><a href="#building-sql-queries-with-table.search_sql" id="toc-building-sql-queries-with-table.search_sql" class="nav-link" data-scroll-target="#building-sql-queries-with-table.search_sql">Building SQL queries with table.search_sql()</a></li>
  </ul></li>
  <li><a href="#rebuilding-a-full-text-search-table" id="toc-rebuilding-a-full-text-search-table" class="nav-link" data-scroll-target="#rebuilding-a-full-text-search-table">Rebuilding a full-text search table</a></li>
  <li><a href="#optimizing-a-full-text-search-table" id="toc-optimizing-a-full-text-search-table" class="nav-link" data-scroll-target="#optimizing-a-full-text-search-table">Optimizing a full-text search table</a></li>
  <li><a href="#cached-table-counts-using-triggers" id="toc-cached-table-counts-using-triggers" class="nav-link" data-scroll-target="#cached-table-counts-using-triggers">Cached table counts using triggers</a></li>
  <li><a href="#creating-indexes" id="toc-creating-indexes" class="nav-link" data-scroll-target="#creating-indexes">Creating indexes</a></li>
  <li><a href="#optimizing-index-usage-with-analyze" id="toc-optimizing-index-usage-with-analyze" class="nav-link" data-scroll-target="#optimizing-index-usage-with-analyze">Optimizing index usage with ANALYZE</a></li>
  <li><a href="#vacuum" id="toc-vacuum" class="nav-link" data-scroll-target="#vacuum">Vacuum</a></li>
  <li><a href="#wal-mode" id="toc-wal-mode" class="nav-link" data-scroll-target="#wal-mode">WAL mode</a></li>
  <li><a href="#suggesting-column-types" id="toc-suggesting-column-types" class="nav-link" data-scroll-target="#suggesting-column-types">Suggesting column types</a></li>
  <li><a href="#registering-custom-sql-functions" id="toc-registering-custom-sql-functions" class="nav-link" data-scroll-target="#registering-custom-sql-functions">Registering custom SQL functions</a></li>
  <li><a href="#quoting-strings-for-use-in-sql" id="toc-quoting-strings-for-use-in-sql" class="nav-link" data-scroll-target="#quoting-strings-for-use-in-sql">Quoting strings for use in SQL</a></li>
  <li><a href="#reading-rows-from-a-file" id="toc-reading-rows-from-a-file" class="nav-link" data-scroll-target="#reading-rows-from-a-file">Reading rows from a file</a></li>
  <li><a href="#setting-the-maximum-csv-field-size-limit" id="toc-setting-the-maximum-csv-field-size-limit" class="nav-link" data-scroll-target="#setting-the-maximum-csv-field-size-limit">Setting the maximum CSV field size limit</a></li>
  <li><a href="#detecting-column-types-using-typetracker" id="toc-detecting-column-types-using-typetracker" class="nav-link" data-scroll-target="#detecting-column-types-using-typetracker">Detecting column types using TypeTracker</a></li>
  <li><a href="#spatialite-helpers" id="toc-spatialite-helpers" class="nav-link" data-scroll-target="#spatialite-helpers">SpatiaLite helpers</a>
  <ul class="collapse">
  <li><a href="#initialize-spatialite" id="toc-initialize-spatialite" class="nav-link" data-scroll-target="#initialize-spatialite">Initialize SpatiaLite</a></li>
  <li><a href="#finding-spatialite" id="toc-finding-spatialite" class="nav-link" data-scroll-target="#finding-spatialite">Finding SpatiaLite</a></li>
  <li><a href="#adding-geometry-columns" id="toc-adding-geometry-columns" class="nav-link" data-scroll-target="#adding-geometry-columns">Adding geometry columns</a></li>
  <li><a href="#creating-a-spatial-index" id="toc-creating-a-spatial-index" class="nav-link" data-scroll-target="#creating-a-spatial-index">Creating a spatial index</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/seeM/nbdev-sqlite-utils/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">sqlite_utils Python library</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p><em>Note: the notebook does not currently execute end-to-end due to <a href="https://github.com/simonw/sqlite-utils/issues/235">issue #235</a></em>.</p>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">Getting started</h2>
<p>Here’s how to create a new SQLite database file containing a new <code>chickens</code> table, populated with four records:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlite_utils <span class="im">import</span> Database</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlite_utils.utils <span class="im">import</span> sqlite3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/chickens.db"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"chickens"</span>].insert_all([{</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Azi"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"color"</span>: <span class="st">"blue"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>}, {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Lila"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"color"</span>: <span class="st">"blue"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>}, {</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Suna"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"color"</span>: <span class="st">"gold"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>}, {</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Cardi"</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"color"</span>: <span class="st">"black"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can loop through those rows like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db[<span class="st">"chickens"</span>].rows:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'name': 'Azi', 'color': 'blue'}
{'name': 'Lila', 'color': 'blue'}
{'name': 'Suna', 'color': 'gold'}
{'name': 'Cardi', 'color': 'black'}</code></pre>
</div>
</div>
<p>To run a SQL query, use <code>db.query()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db.query(<span class="st">"""</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="st">    select color, count(*)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="st">    from chickens group by color</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="st">    order by count(*) desc</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>):</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'color': 'blue', 'count(*)': 2}
{'color': 'gold', 'count(*)': 1}
{'color': 'black', 'count(*)': 1}</code></pre>
</div>
</div>
</section>
<section id="connecting-to-or-creating-a-database" class="level2">
<h2 class="anchored" data-anchor-id="connecting-to-or-creating-a-database">Connecting to or creating a database</h2>
<p>Database objects are constructed by passing in either a path to a file on disk or an existing SQLite3 database connection:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/my_database.db"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will create <code>../test/my_database.db</code> if it does not already exist.</p>
<p>If you want to recreate a database from scratch (first removing the existing file from disk if it already exists) you can use the <code>recreate=True</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/my_database.db"</span>, recreate<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Instead of a file path you can pass in an existing SQLite connection:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(sqlite3.<span class="ex">connect</span>(<span class="st">"../test/my_database.db"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you want to create an in-memory database, you can do so like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can also create a named in-memory database. Unlike regular memory databases these can be accessed by multiple threads, provided at least one reference to the database still exists. <code>del db</code> will clear the database from memory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory_name<span class="op">=</span><span class="st">"my_shared_database"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Connections use <code>PRAGMA recursive_triggers=on</code> by default. If you don’t want to use <a href="https://www.sqlite.org/pragma.html#pragma_recursive_triggers">recursive triggers</a> you can turn them off using:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>, recursive_triggers<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="attaching-additional-databases" class="level3">
<h3 class="anchored" data-anchor-id="attaching-additional-databases">Attaching additional databases</h3>
<p>SQLite supports cross-database SQL queries, which can join data from tables in more than one database file.</p>
<p>You can attach an additional database using the <code>.attach()</code> method, providing an alias to use for that database and the path to the SQLite file on disk.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>Database(<span class="st">"../test/first.db"</span>, recreate<span class="op">=</span><span class="va">True</span>)[<span class="st">"table_in_first"</span>].insert({<span class="st">"color"</span>: <span class="st">"blue"</span>})</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>Database(<span class="st">"../test/second.db"</span>, recreate<span class="op">=</span><span class="va">True</span>)[<span class="st">"table_in_second"</span>].insert({<span class="st">"color"</span>: <span class="st">"red"</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/first.db"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>db.attach(<span class="st">"second"</span>, <span class="st">"../test/second.db"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now you can run queries like this one:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db.query(<span class="st">"""</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="st">select * from table_in_first</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">    union all</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="st">select * from second.table_in_second</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>):</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'color': 'blue'}
{'color': 'red'}</code></pre>
</div>
</div>
<p>You can reference tables in the attached database using the alias value you passed to <code>db.attach(alias, filepath)</code> as a prefix, for example the <code>second.table_in_second</code> reference in the SQL query above.</p>
</section>
<section id="tracing-queries" class="level3">
<h3 class="anchored" data-anchor-id="tracing-queries">Tracing queries</h3>
<p>You can use the <code>tracer</code> mechanism to see SQL queries that are being executed by SQLite. A tracer is a function that you provide which will be called with <code>sql</code> and <code>params</code> arguments every time SQL is executed, for example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tracer(sql, params):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SQL: </span><span class="sc">{}</span><span class="st"> - params: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(sql, params))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can pass this function to the <code>Database()</code> constructor like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>, tracer<span class="op">=</span>tracer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>SQL: PRAGMA recursive_triggers=on; - params: None</code></pre>
</div>
</div>
<p>You can also turn on a tracer function temporarily for a block of code using the <code>with db.tracer(...)</code> context manager:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ... later</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> db.tracer(<span class="bu">print</span>):</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    db[<span class="st">"dogs"</span>].insert({<span class="st">"name"</span>: <span class="st">"Cleo"</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>select name from sqlite_master where type = 'view' None
select name from sqlite_master where type = 'table' None
select name from sqlite_master where type = 'view' None
CREATE TABLE [dogs] (
   [name] TEXT
);
         None
select name from sqlite_master where type = 'view' None
INSERT INTO [dogs] ([name]) VALUES (?); ['Cleo']</code></pre>
</div>
</div>
<p>This example will print queries only for the duration of the <code>with</code> block.</p>
</section>
</section>
<section id="executing-queries" class="level2">
<h2 class="anchored" data-anchor-id="executing-queries">Executing queries</h2>
<p>The <code>Database</code> class offers several methods for directly executing SQL queries.</p>
<section id="db.querysql-params" class="level3">
<h3 class="anchored" data-anchor-id="db.querysql-params">db.query(sql, params)</h3>
<p>The <code>db.query(sql)</code> function executes a SQL query and returns an iterator over Python dictionaries representing the resulting rows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db.query(<span class="st">"select * from dogs"</span>):</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'name': 'Cleo'}
{'name': 'Pancakes'}</code></pre>
</div>
</div>
</section>
<section id="db.executesql-params" class="level3">
<h3 class="anchored" data-anchor-id="db.executesql-params">db.execute(sql, params)</h3>
<p>The <code>db.execute()</code> and <code>db.executescript()</code> methods provide wrappers around <code>.execute()</code> and <code>.executescript()</code> on the underlying SQLite connection. These wrappers log to the <code>tracer</code> if one has been registered.</p>
<p><code>db.execute(sql)</code> returns a <code>sqlite3.Cursor</code> that was used to execute the SQL.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>cursor <span class="op">=</span> db.execute(<span class="st">"update dogs set name = 'Cleopaws'"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Outputs the number of rows affected by the update</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>cursor.rowcount</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>2</code></pre>
</div>
</div>
<p>Other cursor methods such as <code>.fetchone()</code> and <code>.fetchall()</code> are also available, see the <a href="https://docs.python.org/3/library/sqlite3.html#sqlite3.Cursor">standard library documentation</a></p>
</section>
<section id="passing-parameters" class="level3">
<h3 class="anchored" data-anchor-id="passing-parameters">Passing parameters</h3>
<p>Both <code>db.query()</code> and <code>db.execute()</code> accept an optional second argument for parameters to be passed to the SQL query.</p>
<p>This can take the form of either a tuple/list or a dictionary, depending on the type of parameters used in the query. Values passed in this way will be correctly quoted and escaped, helping avoid SQL injection vulnerabilities.</p>
<p><code>?</code> parameters in the SQL query can be filled in using a list:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>db.execute(<span class="st">"update dogs set name = ?"</span>, [<span class="st">"Cleopaws"</span>])<span class="op">;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This will rename ALL dogs to be called "Cleopaws"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Named parameters using <code>:name</code> can be filled using a dictionary:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(db.query(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"select rowid, name from dogs where name = :name"</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"name"</span>: <span class="st">"Cleopaws"</span>}</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'rowid': 1, 'name': 'Cleopaws'}</code></pre>
</div>
</div>
<p>In this example <code>next()</code> is used to retrieve the first result in the iterator returned by the <code>db.query()</code> method.</p>
</section>
</section>
<section id="accessing-tables" class="level2">
<h2 class="anchored" data-anchor-id="accessing-tables">Accessing tables</h2>
<p>Tables are accessed using the indexing operator, like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> db[<span class="st">"my_table"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If the table does not yet exist, it will be created the first time you attempt to insert or upsert data into it.</p>
<p>You can also access tables using the <code>.table()</code> method like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> db.table(<span class="st">"my_table"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using this factory function allows you to set <code>python_api_table_configuration</code>.</p>
</section>
<section id="listing-tables" class="level2">
<h2 class="anchored" data-anchor-id="listing-tables">Listing tables</h2>
<p>You can list the names of tables in a database using the <code>.table_names()</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>db.table_names()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['dogs']</code></pre>
</div>
</div>
<p>To see just the FTS4 tables, use <code>.table_names(fts4=True)</code>. For FTS5, use <code>.table_names(fts5=True)</code>.</p>
<p>You can also iterate through the table objects themselves using the <code>.tables</code> property:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>db.tables</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[&lt;Table dogs (name)&gt;]</code></pre>
</div>
</div>
</section>
<section id="listing-views" class="level2">
<h2 class="anchored" data-anchor-id="listing-views">Listing views</h2>
<p><code>.view_names()</code> shows you a list of views in the database:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>db.view_names()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['good_dogs']</code></pre>
</div>
</div>
<p>You can iterate through view objects using the <code>.views</code> property:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>db.views</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[&lt;View good_dogs (name)&gt;]</code></pre>
</div>
</div>
<p>View objects are similar to Table objects, except that any attempts to insert or update data will throw an error. The full list of methods and properties available on a view object is as follows:</p>
<p><code>columns</code></p>
<p><code>columns_dict</code></p>
<p><code>count</code></p>
<p><code>schema</code></p>
<p><code>rows</code></p>
<p><code>rows_where(where, where_args, order_by, select)</code></p>
<p><code>drop()</code></p>
</section>
<section id="listing-rows" class="level2">
<h2 class="anchored" data-anchor-id="listing-rows">Listing rows</h2>
<p>To iterate through dictionaries for each of the rows in a table, use <code>.rows</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/dogs.db"</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db[<span class="st">"dogs"</span>].rows:</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'id': 1, 'age': 4, 'name': 'Cleo'}
{'id': 2, 'age': 2, 'name': 'Pancakes'}</code></pre>
</div>
</div>
<p>You can filter rows by a WHERE clause using <code>.rows_where(where, where_args)</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db[<span class="st">"dogs"</span>].rows_where(<span class="st">"age &gt; ?"</span>, [<span class="dv">3</span>]):</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'id': 1, 'age': 4, 'name': 'Cleo'}</code></pre>
</div>
</div>
<p>The first argument is a fragment of SQL. The second, optional argument is values to be passed to that fragment - you can use <code>?</code> placeholders and pass an array, or you can use <code>:named</code> parameters and pass a dictionary, like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db[<span class="st">"dogs"</span>].rows_where(<span class="st">"age &gt; :age"</span>, {<span class="st">"age"</span>: <span class="dv">3</span>}):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'id': 1, 'age': 4, 'name': 'Cleo'}</code></pre>
</div>
</div>
<p>To return custom columns (instead of the default that uses <code>select *</code>) pass <code>select="column1, column2"</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db[<span class="st">"dogs"</span>].rows_where(select<span class="op">=</span><span class="st">'name, age'</span>):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'name': 'Cleo', 'age': 4}
{'name': 'Pancakes', 'age': 2}</code></pre>
</div>
</div>
<p>To specify an order, use the <code>order_by=</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db[<span class="st">"dogs"</span>].rows_where(<span class="st">"age &gt; 1"</span>, order_by<span class="op">=</span><span class="st">"age"</span>):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'id': 2, 'age': 2, 'name': 'Pancakes'}
{'id': 1, 'age': 4, 'name': 'Cleo'}</code></pre>
</div>
</div>
<p>You can use <code>order_by="age desc"</code> for descending order.</p>
<p>You can order all records in the table by excluding the <code>where</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db[<span class="st">"dogs"</span>].rows_where(order_by<span class="op">=</span><span class="st">"age desc"</span>):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'id': 1, 'age': 4, 'name': 'Cleo'}
{'id': 2, 'age': 2, 'name': 'Pancakes'}</code></pre>
</div>
</div>
<p>This method also accepts <code>offset=</code> and <code>limit=</code> arguments, for specifying an OFFSET and a LIMIT for the SQL query:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> db[<span class="st">"dogs"</span>].rows_where(order_by<span class="op">=</span><span class="st">"age desc"</span>, limit<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'id': 1, 'age': 4, 'name': 'Cleo'}</code></pre>
</div>
</div>
<section id="counting-rows" class="level3">
<h3 class="anchored" data-anchor-id="counting-rows">Counting rows</h3>
<p>To count the number of rows that would be returned by a where filter, use <code>.count_where(where, where_args)</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].count_where(<span class="st">"age &gt; 1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>2</code></pre>
</div>
</div>
</section>
</section>
<section id="listing-rows-with-their-primary-keys" class="level2">
<h2 class="anchored" data-anchor-id="listing-rows-with-their-primary-keys">Listing rows with their primary keys</h2>
<p>Sometimes it can be useful to retrieve the primary key along with each row, in order to pass that key (or primary key tuple) to the <code>.get()</code> or <code>.update()</code> methods.</p>
<p>The <code>.pks_and_rows_where()</code> method takes the same signature as <code>.rows_where()</code> (with the exception of the <code>select=</code> parameter) but returns a generator that yields pairs of <code>(primary key, row dictionary)</code>.</p>
<p>The primary key value will usually be a single value but can also be a tuple if the table has a compound primary key.</p>
<p>If the table is a <code>rowid</code> table (with no explicit primary key column) then that ID will be returned.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].insert({<span class="st">"name"</span>: <span class="st">"Cleo"</span>})</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pk, row <span class="kw">in</span> db[<span class="st">"dogs"</span>].pks_and_rows_where():</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(pk, row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1 {'rowid': 1, 'name': 'Cleo'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs_with_pk"</span>].insert({<span class="st">"id"</span>: <span class="dv">5</span>, <span class="st">"name"</span>: <span class="st">"Cleo"</span>}, pk<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pk, row <span class="kw">in</span> db[<span class="st">"dogs_with_pk"</span>].pks_and_rows_where():</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(pk, row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5 {'id': 5, 'name': 'Cleo'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs_with_compound_pk"</span>].insert(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"species"</span>: <span class="st">"dog"</span>, <span class="st">"id"</span>: <span class="dv">3</span>, <span class="st">"name"</span>: <span class="st">"Cleo"</span>},</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    pk<span class="op">=</span>(<span class="st">"species"</span>, <span class="st">"id"</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pk, row <span class="kw">in</span> db[<span class="st">"dogs_with_compound_pk"</span>].pks_and_rows_where():</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(pk, row)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>('dog', 3) {'species': 'dog', 'id': 3, 'name': 'Cleo'}</code></pre>
</div>
</div>
</section>
<section id="retrieving-a-specific-record" class="level2">
<h2 class="anchored" data-anchor-id="retrieving-a-specific-record">Retrieving a specific record</h2>
<p>You can retrieve a record by its primary key using <code>table.get()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/dogs.db"</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].get(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'id': 1, 'age': 4, 'name': 'Cleo'}</code></pre>
</div>
</div>
<p>If the table has a compound primary key you can pass in the primary key values as a tuple:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"compound_dogs"</span>].get((<span class="st">"mixed"</span>, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'species': 'mixed', 'id': 3, 'name': 'Axel'}</code></pre>
</div>
</div>
<p>If the record does not exist a <code>NotFoundError</code> will be raised:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlite_utils.db <span class="im">import</span> NotFoundError</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> db[<span class="st">"dogs"</span>].get(<span class="dv">5</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> NotFoundError:</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Dog not found"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dog not found</code></pre>
</div>
</div>
</section>
<section id="showing-the-schema" class="level2">
<h2 class="anchored" data-anchor-id="showing-the-schema">Showing the schema</h2>
<p>The <code>db.schema</code> property returns the full SQL schema for the database as a string:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/dogs.db"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db.schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [dogs] (
   [id] INTEGER,
   [age] INTEGER,
   [name] TEXT
);
CREATE TABLE [compound_dogs] (
   [species] TEXT,
   [id] INTEGER,
   [name] TEXT,
   PRIMARY KEY ([species], [id])
);</code></pre>
</div>
</div>
</section>
<section id="creating-tables" class="level2">
<h2 class="anchored" data-anchor-id="creating-tables">Creating tables</h2>
<p>The easiest way to create a new table is to insert a record into it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>dogs <span class="op">=</span> db[<span class="st">"dogs"</span>]</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>dogs.insert({</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Cleo"</span>,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"twitter"</span>: <span class="st">"cleopaws"</span>,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>: <span class="dv">3</span>,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_good_dog"</span>: <span class="va">True</span>,</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will automatically create a new table called “dogs” with the following schema:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dogs.schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [dogs] (
   [name] TEXT,
   [twitter] TEXT,
   [age] INTEGER,
   [is_good_dog] INTEGER
)</code></pre>
</div>
</div>
<p>You can also specify a primary key by passing the <code>pk=</code> parameter to the <code>.insert()</code> call. This will only be obeyed if the record being inserted causes the table to be created:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>dogs <span class="op">=</span> db[<span class="st">"dogs"</span>]</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].insert({</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">1</span>,</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Cleo"</span>,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"twitter"</span>: <span class="st">"cleopaws"</span>,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>: <span class="dv">3</span>,</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_good_dog"</span>: <span class="va">True</span>,</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>}, pk<span class="op">=</span><span class="st">"id"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After inserting a row like this, the <code>dogs.last_rowid</code> property will return the SQLite <code>rowid</code> assigned to the most recently inserted record.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>dogs.last_rowid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>dogs.last_pk</code> property will return the last inserted primary key value, if you specified one. This can be very useful when writing code that creates foreign keys or many-to-many relationships.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>dogs.last_pk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="custom-column-order-and-column-types" class="level3">
<h3 class="anchored" data-anchor-id="custom-column-order-and-column-types">Custom column order and column types</h3>
<p>The order of the columns in the table will be derived from the order of the keys in the dictionary, provided you are using Python 3.6 or later.</p>
<p>If you want to explicitly set the order of the columns you can do so using the <code>column_order=</code> parameter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].insert({</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">1</span>,</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Cleo"</span>,</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"twitter"</span>: <span class="st">"cleopaws"</span>,</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>: <span class="dv">3</span>,</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_good_dog"</span>: <span class="va">True</span>,</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>}, pk<span class="op">=</span><span class="st">"id"</span>, column_order<span class="op">=</span>(<span class="st">"id"</span>, <span class="st">"twitter"</span>, <span class="st">"name"</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You don’t need to pass all of the columns to the <code>column_order</code> parameter. If you only pass a subset of the columns the remaining columns will be ordered based on the key order of the dictionary.</p>
<p>Column types are detected based on the example data provided. Sometimes you may find you need to over-ride these detected types - to create an integer column for data that was provided as a string for example, or to ensure that a table where the first example was <code>None</code> is created as an <code>INTEGER</code> rather than a <code>TEXT</code> column. You can do this using the <code>columns=</code> parameter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].insert({</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">1</span>,</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Cleo"</span>,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>: <span class="st">"5"</span>,</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>}, pk<span class="op">=</span><span class="st">"id"</span>, columns<span class="op">=</span>{<span class="st">"age"</span>: <span class="bu">int</span>, <span class="st">"weight"</span>: <span class="bu">float</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will create a table with the following schema:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"dogs"</span>].schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [dogs] (
   [id] INTEGER PRIMARY KEY,
   [name] TEXT,
   [age] INTEGER,
   [weight] FLOAT
)</code></pre>
</div>
</div>
</section>
<section id="explicitly-creating-a-table" class="level3">
<h3 class="anchored" data-anchor-id="explicitly-creating-a-table">Explicitly creating a table</h3>
<p>You can directly create a new table without inserting any data into it using the <code>.create()</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"cats"</span>].create({</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="bu">int</span>,</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="bu">str</span>,</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"weight"</span>: <span class="bu">float</span>,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>}, pk<span class="op">=</span><span class="st">"id"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first argument here is a dictionary specifying the columns you would like to create. Each column is paired with a Python type indicating the type of column. See <code>python_api_add_column</code> for full details on how these types work.</p>
<p>This method takes optional arguments <code>pk=</code>, <code>column_order=</code>, <code>foreign_keys=</code>, <code>not_null=set()</code> and <code>defaults=dict()</code> - explained below.</p>
<p>A <code>sqlite_utils.utils.sqlite3.OperationalError</code> will be raised if a table of that name already exists.</p>
<p>To do nothing if the table already exists, add <code>if_not_exists=True</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"cats"</span>].create({</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="bu">int</span>,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="bu">str</span>,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"weight"</span>: <span class="bu">float</span>,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>}, pk<span class="op">=</span><span class="st">"id"</span>, if_not_exists<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compound-primary-keys" class="level3">
<h3 class="anchored" data-anchor-id="compound-primary-keys">Compound primary keys</h3>
<p>If you want to create a table with a compound primary key that spans multiple columns, you can do so by passing a tuple of column names to any of the methods that accept a <code>pk=</code> parameter. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"cats"</span>].create({</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="bu">int</span>,</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"breed"</span>: <span class="bu">str</span>,</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="bu">str</span>,</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"weight"</span>: <span class="bu">float</span>,</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>}, pk<span class="op">=</span>(<span class="st">"breed"</span>, <span class="st">"id"</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This also works for the <code>.insert()</code>, <code>.insert_all()</code>, <code>.upsert()</code> and <code>.upsert_all()</code> methods.</p>
</section>
<section id="specifying-foreign-keys" class="level3">
<h3 class="anchored" data-anchor-id="specifying-foreign-keys">Specifying foreign keys</h3>
<p>Any operation that can create a table (<code>.create()</code>, <code>.insert()</code>, <code>.insert_all()</code>, <code>.upsert()</code> and <code>.upsert_all()</code>) accepts an optional <code>foreign_keys=</code> argument which can be used to set up foreign key constraints for the table that is being created.</p>
<p>If you are using your database with <a href="https://datasette.io/">Datasette</a>, Datasette will detect these constraints and use them to generate hyperlinks to associated records.</p>
<p>The <code>foreign_keys</code> argument takes a list that indicates which foreign keys should be created. The list can take several forms. The simplest is a list of columns:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>foreign_keys<span class="op">=</span>[<span class="st">"author_id"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The library will guess which tables you wish to reference based on the column names using the rules described in <code>python_api_add_foreign_key</code>.</p>
<p>You can also be more explicit, by passing in a list of tuples:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>foreign_keys<span class="op">=</span>[</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"author_id"</span>, <span class="st">"authors"</span>, <span class="st">"id"</span>)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This means that the <code>author_id</code> column should be a foreign key that references the <code>id</code> column in the <code>authors</code> table.</p>
<p>You can leave off the third item in the tuple to have the referenced column automatically set to the primary key of that table. A full example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"authors"</span>].insert_all([</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Sally"</span>},</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"id"</span>: <span class="dv">2</span>, <span class="st">"name"</span>: <span class="st">"Asheesh"</span>}</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>], pk<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"books"</span>].insert_all([</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"title"</span>: <span class="st">"Hedgehogs of the world"</span>, <span class="st">"author_id"</span>: <span class="dv">1</span>},</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"title"</span>: <span class="st">"How to train your wolf"</span>, <span class="st">"author_id"</span>: <span class="dv">2</span>},</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>], foreign_keys<span class="op">=</span>[</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"author_id"</span>, <span class="st">"authors"</span>)</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="table-configuration-options" class="level2">
<h2 class="anchored" data-anchor-id="table-configuration-options">Table configuration options</h2>
<p>The <code>.insert()</code>, <code>.upsert()</code>, <code>.insert_all()</code> and <code>.upsert_all()</code> methods each take a number of keyword arguments, some of which influence what happens should they cause a table to be created and some of which affect the behavior of those methods.</p>
<p>You can set default values for these methods by accessing the table through the <code>db.table(...)</code> method (instead of using <code>db["table_name"]</code>), like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>authors <span class="op">=</span> db.table(</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"authors"</span>,</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    pk<span class="op">=</span><span class="st">"id"</span>,</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    not_null<span class="op">=</span>{<span class="st">"name"</span>, <span class="st">"score"</span>},</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    column_order<span class="op">=</span>(<span class="st">"id"</span>, <span class="st">"name"</span>, <span class="st">"score"</span>, <span class="st">"url"</span>)</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now you can call .insert() like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>authors.insert({<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Tracy"</span>, <span class="st">"score"</span>: <span class="dv">5</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The configuration options that can be specified in this way are <code>pk</code>, <code>foreign_keys</code>, <code>column_order</code>, <code>not_null</code>, <code>defaults</code>, <code>batch_size</code>, <code>hash_id</code>, <code>hash_id_columns</code>, <code>alter</code>, <code>ignore</code>, <code>replace</code>, <code>extracts</code>, <code>conversions</code>, <code>columns</code>. These are all documented below.</p>
</section>
<section id="setting-defaults-and-not-null-constraints" class="level2">
<h2 class="anchored" data-anchor-id="setting-defaults-and-not-null-constraints">Setting defaults and not null constraints</h2>
<p>Each of the methods that can cause a table to be created take optional arguments <code>not_null=set()</code> and <code>defaults=dict()</code>. The methods that take these optional arguments are:</p>
<p><code>db.create_table(...)</code></p>
<p><code>table.create(...)</code></p>
<p><code>table.insert(...)</code></p>
<p><code>table.insert_all(...)</code></p>
<p><code>table.upsert(...)</code></p>
<p><code>table.upsert_all(...)</code></p>
<p>You can use <code>not_null=</code> to pass a set of column names that should have a <code>NOT NULL</code> constraint set on them when they are created.</p>
<p>You can use <code>defaults=</code> to pass a dictionary mapping columns to the default value that should be specified in the <code>CREATE TABLE</code> statement.</p>
<p>Here’s an example that uses these features:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"authors"</span>].insert_all(</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    [{<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Sally"</span>, <span class="st">"score"</span>: <span class="dv">2</span>}],</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    pk<span class="op">=</span><span class="st">"id"</span>,</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    not_null<span class="op">=</span>{<span class="st">"name"</span>, <span class="st">"score"</span>},</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    defaults<span class="op">=</span>{<span class="st">"score"</span>: <span class="dv">1</span>},</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"authors"</span>].insert({<span class="st">"name"</span>: <span class="st">"Dharma"</span>})</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(db[<span class="st">"authors"</span>].rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'id': 1, 'name': 'Sally', 'score': 2},
 {'id': 2, 'name': 'Dharma', 'score': 1}]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"authors"</span>].schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [authors] (
   [id] INTEGER PRIMARY KEY,
   [name] TEXT NOT NULL,
   [score] INTEGER NOT NULL DEFAULT 1
)</code></pre>
</div>
</div>
</section>
<section id="duplicating-tables" class="level2">
<h2 class="anchored" data-anchor-id="duplicating-tables">Duplicating tables</h2>
<p>The <code>table.duplicate()</code> method creates a copy of the table, copying both the table schema and all of the rows in that table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>authors_copy <span class="op">=</span> db[<span class="st">"authors"</span>].duplicate(<span class="st">"authors_copy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The new <code>authors_copy</code> table will now contain a duplicate copy of the data from <code>authors</code>.</p>
<p>This method raises <code>sqlite_utils.db.NoTable</code> if the table does not exist.</p>
</section>
<section id="bulk-inserts" class="level2">
<h2 class="anchored" data-anchor-id="bulk-inserts">Bulk inserts</h2>
<p>If you have more than one record to insert, the <code>insert_all()</code> method is a much more efficient way of inserting them. Just like <code>insert()</code> it will automatically detect the columns that should be created, but it will inspect the first batch of 100 items to help decide what those column types should be.</p>
<p>Use it like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].insert_all([{</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">1</span>,</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Cleo"</span>,</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"twitter"</span>: <span class="st">"cleopaws"</span>,</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>: <span class="dv">3</span>,</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_good_dog"</span>: <span class="va">True</span>,</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>}, {</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">2</span>,</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Marnie"</span>,</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"twitter"</span>: <span class="st">"MarnieTheDog"</span>,</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>: <span class="dv">16</span>,</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_good_dog"</span>: <span class="va">True</span>,</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>}], pk<span class="op">=</span><span class="st">"id"</span>, column_order<span class="op">=</span>(<span class="st">"id"</span>, <span class="st">"twitter"</span>, <span class="st">"name"</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The column types used in the <code>CREATE TABLE</code> statement are automatically derived from the types of data in that first batch of rows. Any additional columns in subsequent batches will cause a <code>sqlite3.OperationalError</code> exception to be raised unless the <code>alter=True</code> argument is supplied, in which case the new columns will be created.</p>
<p>The function can accept an iterator or generator of rows and will commit them according to the batch size. The default batch size is 100, but you can specify a different size using the <code>batch_size</code> parameter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"big_table"</span>].insert_all(({</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">1</span>,</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Name </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(i),</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10000</span>)), batch_size<span class="op">=</span><span class="dv">1000</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can skip inserting any records that have a primary key that already exists using <code>ignore=True</code>. This works with both <code>.insert({...}, ignore=True)</code> and <code>.insert_all([...], ignore=True)</code>.</p>
<p>You can delete all the existing rows in the table before inserting the new records using <code>truncate=True</code>. This is useful if you want to replace the data in the table.</p>
<p>Pass <code>analyze=True</code> to run <code>ANALYZE</code> against the table after inserting the new records.</p>
</section>
<section id="insert-replacing-data" class="level2">
<h2 class="anchored" data-anchor-id="insert-replacing-data">Insert-replacing data</h2>
<p>If you try to insert data using a primary key that already exists, the <code>.insert()</code> or <code>.insert_all()</code> method will raise a <code>sqlite3.IntegrityError</code> exception.</p>
<p>This example that catches that exception:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].insert({<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Cleo"</span>}, pk<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    db[<span class="st">"dogs"</span>].insert({<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Cleo"</span>}, pk<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> sqlite3.IntegrityError:</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Record already exists with that primary key"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Record already exists with that primary key</code></pre>
</div>
</div>
<p>Importing from <code>sqlite_utils.utils.sqlite3</code> ensures your code continues to work even if you are using the <code>pysqlite3</code> library instead of the Python standard library <code>sqlite3</code> module.</p>
<p>Use the <code>ignore=True</code> parameter to ignore this error:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This fails silently if a record with id=1 already exists</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].insert({<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Cleo"</span>}, pk<span class="op">=</span><span class="st">"id"</span>, ignore<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To replace any existing records that have a matching primary key, use the <code>replace=True</code> parameter to <code>.insert()</code> or <code>.insert_all()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].insert_all([{</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">1</span>,</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Cleo"</span>,</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>}, {</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">2</span>,</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Marnie"</span>,</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>}], pk<span class="op">=</span><span class="st">"id"</span>, replace<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Prior to sqlite-utils 2.0 the <code>.upsert()</code> and <code>.upsert_all()</code> methods worked the same way as <code>.insert(replace=True)</code> does today. See <code>python_api_upsert</code> for the new behaviour of those methods introduced in 2.0.</p>
</div>
</div>
</section>
<section id="updating-a-specific-record" class="level2">
<h2 class="anchored" data-anchor-id="updating-a-specific-record">Updating a specific record</h2>
<p>You can update a record by its primary key using <code>table.update()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/dogs.db"</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"dogs"</span>].get(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'id': 1, 'age': 4, 'name': 'Cleo'}</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].update(<span class="dv">1</span>, {<span class="st">"age"</span>: <span class="dv">5</span>})</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"dogs"</span>].get(<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'id': 1, 'age': 5, 'name': 'Cleo'}</code></pre>
</div>
</div>
<p>The first argument to <code>update()</code> is the primary key. This can be a single value, or a tuple if that table has a compound primary key:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"compound_dogs"</span>].update((<span class="st">'mixed'</span>, <span class="dv">3</span>), {<span class="st">"name"</span>: <span class="st">"Updated"</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The second argument is a dictionary of columns that should be updated, along with their new values.</p>
<p>You can cause any missing columns to be added automatically using <code>alter=True</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].update(<span class="dv">1</span>, {<span class="st">"breed"</span>: <span class="st">"Mutt"</span>}, alter<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="deleting-a-specific-record" class="level2">
<h2 class="anchored" data-anchor-id="deleting-a-specific-record">Deleting a specific record</h2>
<p>You can delete a record using <code>table.delete()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/dogs.db"</span>)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].delete(<span class="dv">1</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>delete()</code> method takes the primary key of the record. This can be a tuple of values if the row has a compound primary key:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"compound_dogs"</span>].delete((<span class="st">'mixed'</span>, <span class="dv">3</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="deleting-multiple-records" class="level2">
<h2 class="anchored" data-anchor-id="deleting-multiple-records">Deleting multiple records</h2>
<p>You can delete all records in a table that match a specific WHERE statement using <code>table.delete_where()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/dogs.db"</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete every dog with age less than 3</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].delete_where(<span class="st">"age &lt; ?"</span>, [<span class="dv">3</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Calling <code>table.delete_where()</code> with no other arguments will delete every row in the table.</p>
<p>Pass <code>analyze=True</code> to run <code>ANALYZE</code> against the table after deleting the rows.</p>
</section>
<section id="upserting-data" class="level2">
<h2 class="anchored" data-anchor-id="upserting-data">Upserting data</h2>
<p>Upserting allows you to insert records if they do not exist and update them if they DO exist, based on matching against their primary key.</p>
<p>For example, given the dogs database you could upsert the record for Cleo like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].upsert({</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">1</span>,</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Cleo"</span>,</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"twitter"</span>: <span class="st">"cleopaws"</span>,</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>: <span class="dv">4</span>,</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_good_dog"</span>: <span class="va">True</span>,</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>}, pk<span class="op">=</span><span class="st">"id"</span>, column_order<span class="op">=</span>(<span class="st">"id"</span>, <span class="st">"twitter"</span>, <span class="st">"name"</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If a record exists with id=1, it will be updated to match those fields. If it does not exist it will be created.</p>
<p>Any existing columns that are not referenced in the dictionary passed to <code>.upsert()</code> will be unchanged. If you want to replace a record entirely, use <code>.insert(doc, replace=True)</code> instead.</p>
<p>Note that the <code>pk</code> and <code>column_order</code> parameters here are optional if you are certain that the table has already been created. You should pass them if the table may not exist at the time the first upsert is performed.</p>
<p>An <code>upsert_all()</code> method is also available, which behaves like <code>insert_all()</code> but performs upserts instead.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>.upsert()</code> and <code>.upsert_all()</code> in sqlite-utils 1.x worked like <code>.insert(..., replace=True)</code> and <code>.insert_all(..., replace=True)</code> do in 2.x. See <a href="https://github.com/simonw/sqlite-utils/issues/66">issue #66</a> for details of this change.</p>
</div>
</div>
</section>
<section id="converting-data-in-columns" class="level2">
<h2 class="anchored" data-anchor-id="converting-data-in-columns">Converting data in columns</h2>
<p>The <code>table.convert(...)</code> method can be used to apply a conversion function to the values in a column, either to update that column or to populate new columns. It is the Python library equivalent of the <code>sqlite-utils</code> command.</p>
<p>This feature works by registering a custom SQLite function that applies a Python transformation, then running a SQL query equivalent to <code>UPDATE table SET column = convert_value(column);</code></p>
<p>To transform a specific column to uppercase, you would use the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].convert(<span class="st">"name"</span>, <span class="kw">lambda</span> value: value.upper())<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can pass a list of columns, in which case the transformation will be applied to each one:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].convert([<span class="st">"name"</span>, <span class="st">"twitter"</span>], <span class="kw">lambda</span> value: value.upper())<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To save the output to of the transformation to a different column, use the <code>output=</code> parameter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].convert(<span class="st">"name"</span>, <span class="kw">lambda</span> value: value.upper(), output<span class="op">=</span><span class="st">"name_upper"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Table dogs (id, twitter, name, age, is_good_dog, name_upper)&gt;</code></pre>
</div>
</div>
<p>This will add the new column, if it does not already exist. You can pass <code>output_type=int</code> or some other type to control the type of the new column - otherwise it will default to text.</p>
<p>If you want to drop the original column after saving the results in a separate output column, pass <code>drop=True</code>.</p>
<p>You can create multiple new columns from a single input column by passing <code>multi=True</code> and a conversion function that returns a Python dictionary. This example creates new <code>upper</code> and <code>lower</code> columns populated from the single <code>title</code> column:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>table.convert(</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"title"</span>, <span class="kw">lambda</span> v: {<span class="st">"upper"</span>: v.upper(), <span class="st">"lower"</span>: v.lower()}, multi<span class="op">=</span><span class="va">True</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>.convert()</code> method accepts optional <code>where=</code> and <code>where_args=</code> parameters which can be used to apply the conversion to a subset of rows specified by a where clause. Here’s how to apply the conversion only to rows with an <code>id</code> that is higher than 20:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>table.convert(<span class="st">"title"</span>, <span class="kw">lambda</span> v: v.upper(), where<span class="op">=</span><span class="st">"id &gt; :id"</span>, where_args<span class="op">=</span>{<span class="st">"id"</span>: <span class="dv">20</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These behave the same as the corresponding parameters to the <code>.rows_where()</code> method, so you can use <code>?</code> placeholders and a list of values instead of <code>:named</code> placeholders with a dictionary.</p>
</section>
<section id="working-with-lookup-tables" class="level2">
<h2 class="anchored" data-anchor-id="working-with-lookup-tables">Working with lookup tables</h2>
<p>A useful pattern when populating large tables in to break common values out into lookup tables. Consider a table of <code>Trees</code>, where each tree has a species. Ideally these species would be split out into a separate <code>Species</code> table, with each one assigned an integer primary key that can be referenced from the <code>Trees</code> table <code>species_id</code> column.</p>
<section id="creating-lookup-tables-explicitly" class="level3">
<h3 class="anchored" data-anchor-id="creating-lookup-tables-explicitly">Creating lookup tables explicitly</h3>
<p>Calling <code>db["Species"].lookup({"name": "Palm"})</code> creates a table called <code>Species</code> (if one does not already exist) with two columns: <code>id</code> and <code>name</code>. It sets up a unique constraint on the <code>name</code> column to guarantee it will not contain duplicate rows. It then inserts a new row with the <code>name</code> set to <code>Palm</code> and returns the new integer primary key value.</p>
<p>If the <code>Species</code> table already exists, it will insert the new row and return the primary key. If a row with that <code>name</code> already exists, it will return the corresponding primary key value directly.</p>
<p>If you call <code>.lookup()</code> against an existing table without the unique constraint it will attempt to add the constraint, raising an <code>IntegrityError</code> if the constraint cannot be created.</p>
<p>If you pass in a dictionary with multiple values, both values will be used to insert or retrieve the corresponding ID and any unique constraint that is created will cover all of those columns, for example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].insert({</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latitude"</span>: <span class="fl">49.1265976</span>,</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"longitude"</span>: <span class="fl">2.5496218</span>,</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"species"</span>: db[<span class="st">"Species"</span>].lookup({</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"common_name"</span>: <span class="st">"Common Juniper"</span>,</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"latin_name"</span>: <span class="st">"Juniperus communis"</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>.lookup()</code> method has an optional second argument which can be used to populate other columns in the table but only if the row does not exist yet. These columns will not be included in the unique index.</p>
<p>To create a species record with a note on when it was first seen, you can use this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Species"</span>].lookup({<span class="st">"name"</span>: <span class="st">"Palm"</span>}, {<span class="st">"first_seen"</span>: <span class="st">"2021-03-04"</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>2</code></pre>
</div>
</div>
<p>The first time this is called the record will be created for <code>name="Palm"</code>. Any subsequent calls with that name will ignore the second argument, even if it includes different values.</p>
<p><code>.lookup()</code> also accepts keyword arguments, which are passed through to the <code>insert()</code> and can be used to influence the shape of the created table. Supported parameters are:</p>
<p><code>pk</code> - which defaults to <code>id</code></p>
<p><code>foreign_keys</code></p>
<p><code>column_order</code></p>
<p><code>not_null</code></p>
<p><code>defaults</code></p>
<p><code>extracts</code></p>
<p><code>conversions</code></p>
<p><code>columns</code></p>
</section>
<section id="populating-lookup-tables-automatically-during-insertupsert" class="level3">
<h3 class="anchored" data-anchor-id="populating-lookup-tables-automatically-during-insertupsert">Populating lookup tables automatically during insert/upsert</h3>
<p>A more efficient way to work with lookup tables is to define them using the <code>extracts=</code> parameter, which is accepted by <code>.insert()</code>, <code>.upsert()</code>, <code>.insert_all()</code>, <code>.upsert_all()</code> and by the <code>.table(...)</code> factory function.</p>
<p><code>extracts=</code> specifies columns which should be “extracted” out into a separate lookup table during the data insertion.</p>
<p>It can be either a list of column names, in which case the extracted table names will match the column names exactly, or it can be a dictionary mapping column names to the desired name of the extracted table.</p>
<p>To extract the <code>species</code> column out to a separate <code>Species</code> table, you can do this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the table factory</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>trees <span class="op">=</span> db.table(<span class="st">"Trees"</span>, extracts<span class="op">=</span>{<span class="st">"species"</span>: <span class="st">"Species"</span>})</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>trees.insert({</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latitude"</span>: <span class="fl">49.1265976</span>,</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"longitude"</span>: <span class="fl">2.5496218</span>,</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"species"</span>: <span class="st">"Common Juniper"</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want the table to be called 'species', you can do this:</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>trees <span class="op">=</span> db.table(<span class="st">"Trees"</span>, extracts<span class="op">=</span>[<span class="st">"species"</span>])</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Using .insert() directly</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].insert({</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"latitude"</span>: <span class="fl">49.1265976</span>,</span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"longitude"</span>: <span class="fl">2.5496218</span>,</span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"species"</span>: <span class="st">"Common Juniper"</span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>}, extracts<span class="op">=</span>{<span class="st">"species"</span>: <span class="st">"Species"</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="working-with-many-to-many-relationships" class="level2">
<h2 class="anchored" data-anchor-id="working-with-many-to-many-relationships">Working with many-to-many relationships</h2>
<p><code>sqlite-utils</code> includes a shortcut for creating records using many-to-many relationships in the form of the <code>table.m2m(...)</code> method.</p>
<p>Here’s how to create two new records and connect them via a many-to-many table in a single line of code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].insert({<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Cleo"</span>}, pk<span class="op">=</span><span class="st">"id"</span>).m2m(</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"humans"</span>, {<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Natalie"</span>}, pk<span class="op">=</span><span class="st">"id"</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Running this example actually creates three tables: <code>dogs</code>, <code>humans</code> and a many-to-many <code>dogs_humans</code> table. It will insert a record into each of those tables.</p>
<p>The <code>.m2m()</code> method executes against the last record that was affected by <code>.insert()</code> or <code>.update()</code> - the record identified by the <code>table.last_pk</code> property. To execute <code>.m2m()</code> against a specific record you can first select it by passing its primary key to <code>.update()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].update(<span class="dv">1</span>).m2m(</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"humans"</span>, {<span class="st">"id"</span>: <span class="dv">2</span>, <span class="st">"name"</span>: <span class="st">"Simon"</span>}, pk<span class="op">=</span><span class="st">"id"</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first argument to <code>.m2m()</code> can be either the name of a table as a string or it can be the table object itself.</p>
<p>The second argument can be a single dictionary record or a list of dictionaries. These dictionaries will be passed to <code>.upsert()</code> against the specified table.</p>
<p>Here’s alternative code that creates the dog record and adds two people to it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>dogs <span class="op">=</span> db.table(<span class="st">"dogs"</span>, pk<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>humans <span class="op">=</span> db.table(<span class="st">"humans"</span>, pk<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>dogs.insert({<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Cleo"</span>}).m2m(</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    humans, [</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Natalie"</span>},</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"id"</span>: <span class="dv">2</span>, <span class="st">"name"</span>: <span class="st">"Simon"</span>}</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The method will attempt to find an existing many-to-many table by looking for a table that has foreign key relationships against both of the tables in the relationship.</p>
<p>If it cannot find such a table, it will create a new one using the names of the two tables - <code>dogs_humans</code> in this example. You can customize the name of this table using the <code>m2m_table=</code> argument to <code>.m2m()</code>.</p>
<p>It it finds multiple candidate tables with foreign keys to both of the specified tables it will raise a <code>sqlite_utils.db.NoObviousTable</code> exception. You can avoid this error by specifying the correct table using <code>m2m_table=</code>.</p>
<p>The <code>.m2m()</code> method also takes an optional <code>pk=</code> argument to specify the primary key that should be used if the table is created, and an optional <code>alter=True</code> argument to specify that any missing columns of an existing table should be added if they are needed.</p>
<section id="using-m2m-and-lookup-tables-together" class="level3">
<h3 class="anchored" data-anchor-id="using-m2m-and-lookup-tables-together">Using m2m and lookup tables together</h3>
<p>You can work with (or create) lookup tables as part of a call to <code>.m2m()</code> using the <code>lookup=</code> parameter. This accepts the same argument as <code>table.lookup()</code> does - a dictionary of values that should be used to lookup or create a row in the lookup table.</p>
<p>This example creates a dogs table, populates it, creates a characteristics table, populates that and sets up a many-to-many relationship between the two. It chains <code>.m2m()</code> twice to create two associated characteristics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>dogs <span class="op">=</span> db.table(<span class="st">"dogs"</span>, pk<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>dogs.insert({<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Cleo"</span>}).m2m(</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"characteristics"</span>, lookup<span class="op">=</span>{</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: <span class="st">"Playful"</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>).m2m(</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"characteristics"</span>, lookup<span class="op">=</span>{</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: <span class="st">"Opinionated"</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can inspect the database to see the results like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>db.table_names()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['dogs', 'characteristics', 'characteristics_dogs']</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(db[<span class="st">"dogs"</span>].rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'id': 1, 'name': 'Cleo'}]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(db[<span class="st">"characteristics"</span>].rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'id': 1, 'name': 'Playful'}, {'id': 2, 'name': 'Opinionated'}]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(db[<span class="st">"characteristics_dogs"</span>].rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'characteristics_id': 1, 'dogs_id': 1},
 {'characteristics_id': 2, 'dogs_id': 1}]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"characteristics_dogs"</span>].schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [characteristics_dogs] (
   [characteristics_id] INTEGER REFERENCES [characteristics]([id]),
   [dogs_id] INTEGER REFERENCES [dogs]([id]),
   PRIMARY KEY ([characteristics_id], [dogs_id])
)</code></pre>
</div>
</div>
</section>
</section>
<section id="analyzing-a-column" class="level2">
<h2 class="anchored" data-anchor-id="analyzing-a-column">Analyzing a column</h2>
<p>The <code>table.analyze_column(column, common_limit=10, value_truncate=None)</code> method is used by the <code>analyze-tables</code> CLI command. It returns a <code>ColumnDetails</code> named tuple with the following fields:</p>
<p><code>table</code> – The name of the table</p>
<p><code>column</code> – The name of the column</p>
<p><code>total_rows</code> – The total number of rows in the table</p>
<p><code>num_null</code> – The number of rows for which this column is null</p>
<p><code>num_blank</code> – The number of rows for which this column is blank (the empty string)</p>
<p><code>num_distinct</code> – The number of distinct values in this column</p>
<p><code>most_common</code> – The <code>N</code> most common values as a list of <code>(value, count)</code> tuples, or <code>None</code> if the table consists entirely of distinct values</p>
<p><code>least_common</code> – The <code>N</code> least common values as a list of <code>(value, count)</code> tuples, or <code>None</code> if the table is entirely distinct or if the number of distinct values is less than N (since they will already have been returned in <code>most_common</code>)</p>
<p><code>N</code> defaults to 10, or you can pass a custom <code>N</code> using the <code>common_limit</code> parameter.</p>
<p>You can use the <code>value_truncate</code> parameter to truncate values in the <code>most_common</code> and <code>least_common</code> lists to a specified number of characters.</p>
</section>
<section id="adding-columns" class="level2">
<h2 class="anchored" data-anchor-id="adding-columns">Adding columns</h2>
<p>You can add a new column to a table using the <code>.add_column(col_name, col_type)</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/dogs.db"</span>)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].add_column(<span class="st">"instagram"</span>, <span class="bu">str</span>)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].add_column(<span class="st">"weight"</span>, <span class="bu">float</span>)</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].add_column(<span class="st">"dob"</span>, datetime.date)</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].add_column(<span class="st">"image"</span>, <span class="st">"BLOB"</span>)</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].add_column(<span class="st">"website"</span>)<span class="op">;</span> <span class="co"># str by default</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can specify the <code>col_type</code> argument either using a SQLite type as a string, or by directly passing a Python type e.g.&nbsp;<code>str</code> or <code>float</code>.</p>
<p>The <code>col_type</code> is optional - if you omit it the type of <code>TEXT</code> will be used.</p>
<p>SQLite types you can specify are <code>"TEXT"</code>, <code>"INTEGER"</code>, <code>"FLOAT"</code> or <code>"BLOB"</code>.</p>
<p>If you pass a Python type, it will be mapped to SQLite types as shown here:</p>
<pre><code>float: "FLOAT"
int: "INTEGER"
bool: "INTEGER"
str: "TEXT"
bytes: "BLOB"
datetime.datetime: "TEXT"
datetime.date: "TEXT"
datetime.time: "TEXT"

# If numpy is installed
np.int8: "INTEGER"
np.int16: "INTEGER"
np.int32: "INTEGER"
np.int64: "INTEGER"
np.uint8: "INTEGER"
np.uint16: "INTEGER"
np.uint32: "INTEGER"
np.uint64: "INTEGER"
np.float16: "FLOAT"
np.float32: "FLOAT"
np.float64: "FLOAT"</code></pre>
<p>You can also add a column that is a foreign key reference to another table using the <code>fk</code> parameter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>db.create_table(<span class="st">"species"</span>, {<span class="st">"ref"</span>: <span class="bu">int</span>, <span class="st">"name"</span>: <span class="bu">str</span>}, if_not_exists<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="co"># db["dogs"].add_column("species_id", fk="species") # </span><span class="al">TODO</span><span class="co">: see https://github.com/simonw/sqlite-utils/issues/235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will automatically detect the name of the primary key on the species table and use that (and its type) for the new column.</p>
<p>You can explicitly specify the column you wish to reference using <code>fk_col</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["dogs"].add_column("species_id", fk="species", fk_col="ref") # </span><span class="al">TODO</span><span class="co">: see https://github.com/simonw/sqlite-utils/issues/235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can set a <code>NOT NULL DEFAULT 'x'</code> constraint on the new column using <code>not_null_default</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].add_column(<span class="st">"friends_count"</span>, <span class="bu">int</span>, not_null_default<span class="op">=</span><span class="dv">0</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adding-columns-automatically-on-insertupdate" class="level2">
<h2 class="anchored" data-anchor-id="adding-columns-automatically-on-insertupdate">Adding columns automatically on insert/update</h2>
<p>You can insert or update data that includes new columns and have the table automatically altered to fit the new schema using the <code>alter=True</code> argument. This can be passed to all four of <code>.insert()</code>, <code>.upsert()</code>, <code>.insert_all()</code> and <code>.upsert_all()</code>, or it can be passed to <code>db.table(table_name, alter=True)</code> to enable it by default for all method calls against that table instance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"new_table"</span>].insert({<span class="st">"name"</span>: <span class="st">"Gareth"</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will throw an exception:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    db[<span class="st">"new_table"</span>].insert({<span class="st">"name"</span>: <span class="st">"Gareth"</span>, <span class="st">"age"</span>: <span class="dv">32</span>})</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> sqlite3.OperationalError <span class="im">as</span> e:</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(e)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>table new_table has no column named age</code></pre>
</div>
</div>
<p>This will succeed and add a new “age” integer column:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"new_table"</span>].insert({<span class="st">"name"</span>: <span class="st">"Gareth"</span>, <span class="st">"age"</span>: <span class="dv">32</span>}, alter<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can see confirm the new column like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"new_table"</span>].columns_dict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'name': str, 'age': int}</code></pre>
</div>
</div>
<p>This works too:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>new_table <span class="op">=</span> db.table(<span class="st">"new_table"</span>, alter<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>new_table.insert({<span class="st">"name"</span>: <span class="st">"Gareth"</span>, <span class="st">"age"</span>: <span class="dv">32</span>, <span class="st">"shoe_size"</span>: <span class="dv">11</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adding-foreign-key-constraints" class="level2">
<h2 class="anchored" data-anchor-id="adding-foreign-key-constraints">Adding foreign key constraints</h2>
<p>The SQLite <code>ALTER TABLE</code> statement doesn’t have the ability to add foreign key references to an existing column.</p>
<p>It’s possible to add these references through very careful manipulation of SQLite’s <code>sqlite_master</code> table, using <code>PRAGMA writable_schema</code>.</p>
<p><code>sqlite-utils</code> can do this for you, though there is a significant risk of data corruption if something goes wrong so it is advisable to create a fresh copy of your database file before attempting this.</p>
<p>Here’s an example of this mechanism in action:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/books.db"</span>, recreate<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"authors"</span>].insert_all([</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"id"</span>: <span class="dv">1</span>, <span class="st">"name"</span>: <span class="st">"Sally"</span>},</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"id"</span>: <span class="dv">2</span>, <span class="st">"name"</span>: <span class="st">"Asheesh"</span>}</span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>], pk<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"books"</span>].insert_all([</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"title"</span>: <span class="st">"Hedgehogs of the world"</span>, <span class="st">"author_id"</span>: <span class="dv">1</span>},</span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"title"</span>: <span class="st">"How to train your wolf"</span>, <span class="st">"author_id"</span>: <span class="dv">2</span>},</span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a><span class="co"># db["books"].add_foreign_key("author_id", "authors", "id")  # </span><span class="al">TODO</span><span class="co">: see https://github.com/simonw/sqlite-utils/issues/235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Table books (title, author_id)&gt;</code></pre>
</div>
</div>
<p>The <code>table.add_foreign_key(column, other_table, other_column)</code> method takes the name of the column, the table that is being referenced and the key column within that other table. If you omit the <code>other_column</code> argument the primary key from that table will be used automatically. If you omit the <code>other_table</code> argument the table will be guessed based on some simple rules:</p>
<p>If the column is of format <code>author_id</code>, look for tables called <code>author</code> or <code>authors</code></p>
<p>If the column does not end in <code>_id</code>, try looking for a table with the exact name of the column or that name with an added <code>s</code></p>
<p>This method first checks that the specified foreign key references tables and columns that exist and does not clash with an existing foreign key. It will raise a <code>sqlite_utils.db.AlterError</code> exception if these checks fail.</p>
<p>To ignore the case where the key already exists, use <code>ignore=True</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["books"].add_foreign_key("author_id", "authors", "id", ignore=True) # </span><span class="al">TODO</span><span class="co">: see https://github.com/simonw/sqlite-utils/issues/235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="adding-multiple-foreign-key-constraints-at-once" class="level3">
<h3 class="anchored" data-anchor-id="adding-multiple-foreign-key-constraints-at-once">Adding multiple foreign key constraints at once</h3>
<p>The final step in adding a new foreign key to a SQLite database is to run <code>VACUUM</code>, to ensure the new foreign key is available in future introspection queries.</p>
<p><code>VACUUM</code> against a large (multi-GB) database can take several minutes or longer. If you are adding multiple foreign keys using <code>table.add_foreign_key(...)</code> these can quickly add up.</p>
<p>Instead, you can use <code>db.add_foreign_keys(...)</code> to add multiple foreign keys within a single transaction. This method takes a list of four-tuples, each one specifying a <code>table</code>, <code>column</code>, <code>other_table</code> and <code>other_column</code>.</p>
<p>Here’s an example adding two foreign keys at once:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/dogs.db"</span>)</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="co"># db.add_foreign_keys([</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     ("dogs", "breed_id", "breeds", "id"),</span></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     ("dogs", "home_town_id", "towns", "id")</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ]) # </span><span class="al">TODO</span><span class="co">: see https://github.com/simonw/sqlite-utils/issues/235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This method runs the same checks as <code>.add_foreign_keys()</code> and will raise <code>sqlite_utils.db.AlterError</code> if those checks fail.</p>
</section>
<section id="adding-indexes-for-all-foreign-keys" class="level3">
<h3 class="anchored" data-anchor-id="adding-indexes-for-all-foreign-keys">Adding indexes for all foreign keys</h3>
<p>If you want to ensure that every foreign key column in your database has a corresponding index, you can do so like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>db.index_foreign_keys()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="dropping-a-table-or-view" class="level2">
<h2 class="anchored" data-anchor-id="dropping-a-table-or-view">Dropping a table or view</h2>
<p>You can drop a table or view using the <code>.drop()</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/dogs.db"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].drop()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pass <code>ignore=True</code> if you want to ignore the error caused by the table or view not existing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].drop(ignore<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="transforming-a-table" class="level2">
<h2 class="anchored" data-anchor-id="transforming-a-table">Transforming a table</h2>
<p>The SQLite <code>ALTER TABLE</code> statement is limited. It can add and drop columns and rename tables, but it cannot change column types, change <code>NOT NULL</code> status or change the primary key for a table.</p>
<p>The <code>table.transform()</code> method can do all of these things, by implementing a multi-step pattern <a href="https://www.sqlite.org/lang_altertable.html#otheralter">described in the SQLite documentation</a>:</p>
<ol type="1">
<li>Start a transaction</li>
<li><code>CREATE TABLE tablename_new_x123</code> with the required changes</li>
<li>Copy the old data into the new table using <code>INSERT INTO tablename_new_x123 SELECT * FROM tablename;</code></li>
<li><code>DROP TABLE tablename;</code></li>
<li><code>ALTER TABLE tablename_new_x123 RENAME TO tablename;</code></li>
<li>Commit the transaction</li>
</ol>
<p>The <code>.transform()</code> method takes a number of parameters, all of which are optional.</p>
<section id="altering-column-types" class="level3">
<h3 class="anchored" data-anchor-id="altering-column-types">Altering column types</h3>
<p>To alter the type of a column, use the <code>types=</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the 'age' column to an integer, and 'weight' to a float</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>table.transform(types<span class="op">=</span>{<span class="st">"age"</span>: <span class="bu">int</span>, <span class="st">"weight"</span>: <span class="bu">float</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>See <code>python_api_add_column</code> for a list of available types.</p>
</section>
<section id="renaming-columns" class="level3">
<h3 class="anchored" data-anchor-id="renaming-columns">Renaming columns</h3>
<p>The <code>rename=</code> parameter can rename columns:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename 'age' to 'initial_age':</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>table.transform(rename<span class="op">=</span>{<span class="st">"age"</span>: <span class="st">"initial_age"</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dropping-columns" class="level3">
<h3 class="anchored" data-anchor-id="dropping-columns">Dropping columns</h3>
<p>To drop columns, pass them in the <code>drop=</code> set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop the 'age' column:</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>table.transform(drop<span class="op">=</span>{<span class="st">"age"</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="changing-primary-keys" class="level3">
<h3 class="anchored" data-anchor-id="changing-primary-keys">Changing primary keys</h3>
<p>To change the primary key for a table, use <code>pk=</code>. This can be passed a single column for a regular primary key, or a tuple of columns to create a compound primary key. Passing <code>pk=None</code> will remove the primary key and convert the table into a <code>rowid</code> table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make `user_id` the new primary key</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>table.transform(pk<span class="op">=</span><span class="st">"user_id"</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="changing-not-null-status" class="level3">
<h3 class="anchored" data-anchor-id="changing-not-null-status">Changing not null status</h3>
<p>You can change the <code>NOT NULL</code> status of columns by using <code>not_null=</code>. You can pass this a set of columns to make those columns <code>NOT NULL</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the 'age' and 'weight' columns NOT NULL</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>table.transform(not_null<span class="op">=</span>{<span class="st">"age"</span>, <span class="st">"weight"</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you want to take existing <code>NOT NULL</code> columns and change them to allow null values, you can do so by passing a dictionary of true/false values instead:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 'age' is NOT NULL but we want to allow NULL:</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>table.transform(not_null<span class="op">=</span>{<span class="st">"age"</span>: <span class="va">False</span>})</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make age allow NULL and switch weight to being NOT NULL:</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>table.transform(not_null<span class="op">=</span>{<span class="st">"age"</span>: <span class="va">False</span>, <span class="st">"weight"</span>: <span class="va">True</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="altering-column-defaults" class="level3">
<h3 class="anchored" data-anchor-id="altering-column-defaults">Altering column defaults</h3>
<p>The <code>defaults=</code> parameter can be used to set or change the defaults for different columns:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set default age to 1:</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>table.transform(defaults<span class="op">=</span>{<span class="st">"age"</span>: <span class="dv">1</span>})</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Now remove the default from that column:</span></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>table.transform(defaults<span class="op">=</span>{<span class="st">"age"</span>: <span class="va">None</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="changing-column-order" class="level3">
<h3 class="anchored" data-anchor-id="changing-column-order">Changing column order</h3>
<p>The <code>column_order=</code> parameter can be used to change the order of the columns. If you pass the names of a subset of the columns those will go first and columns you omitted will appear in their existing order after them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Change column order</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>table.transform(column_order<span class="op">=</span>(<span class="st">"name"</span>, <span class="st">"age"</span>, <span class="st">"id"</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="dropping-foreign-key-constraints" class="level3">
<h3 class="anchored" data-anchor-id="dropping-foreign-key-constraints">Dropping foreign key constraints</h3>
<p>You can use <code>.transform()</code> to remove foreign key constraints from a table.</p>
<p>This example drops two foreign keys - the one from <code>places.country</code> to <code>country.id</code> and the one from <code>places.continent</code> to <code>continent.id</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"places"</span>].transform(</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>    drop_foreign_keys<span class="op">=</span>(<span class="st">"country"</span>, <span class="st">"continent"</span>)</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="custom-transformations-with-.transform_sql" class="level3">
<h3 class="anchored" data-anchor-id="custom-transformations-with-.transform_sql">Custom transformations with .transform_sql()</h3>
<p>The <code>.transform()</code> method can handle most cases, but it does not automatically upgrade indexes, views or triggers associated with the table that is being transformed.</p>
<p>If you want to do something more advanced, you can call the <code>table.transform_sql(...)</code> method with the same arguments that you would have passed to <code>table.transform(...)</code>.</p>
<p>This method will return a list of SQL statements that should be executed to implement the change. You can then make modifications to that SQL - or add additional SQL statements - before executing it yourself.</p>
</section>
</section>
<section id="extracting-columns-into-a-separate-table" class="level2">
<h2 class="anchored" data-anchor-id="extracting-columns-into-a-separate-table">Extracting columns into a separate table</h2>
<p>The <code>table.extract()</code> method can be used to extract specified columns into a separate table.</p>
<p>Imagine a <code>Trees</code> table that looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>show_table(db[<span class="st">"Trees"</span>].rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<table class="table"><thead><tr><th>id</th><th>TreeAddress</th><th>Species</th></tr></thead><tbody><tr><td>1</td><td>52 Vine St</td><td>Palm</td></tr><tr><td>2</td><td>12 Draft St</td><td>Oak</td></tr><tr><td>3</td><td>51 Dark Ave</td><td>Palm</td></tr><tr><td>4</td><td>1252 Left St</td><td>Palm</td></tr></tbody></table>
</div>
</div>
<p>The <code>Species</code> column contains duplicate values. This database could be improved by extracting that column out into a separate <code>Species</code> table and pointing to it using a foreign key column.</p>
<p>The schema of the above table is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Markdown</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb165"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> [Trees] (</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>   [<span class="kw">id</span>] <span class="dt">INTEGER</span> <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>   [TreeAddress] TEXT,</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>   [Species] TEXT</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"Trees"</span>].schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [Trees] (
   [id] INTEGER PRIMARY KEY,
   [TreeAddress] TEXT,
   [Species] TEXT
)</code></pre>
</div>
</div>
<p>Here’s how to extract the <code>Species</code> column using <code>.extract()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["Trees"].extract("Species") # </span><span class="al">TODO</span><span class="co">: see https://github.com/simonw/sqlite-utils/issues/235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After running this code the table schema now looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"Trees"</span>].schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [Trees] (
   [id] INTEGER PRIMARY KEY,
   [TreeAddress] TEXT,
   [Species] TEXT
)</code></pre>
</div>
</div>
<p>A new <code>Species</code> table will have been created with the following schema:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print(db["Species"].schema)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>.extract()</code> method defaults to creating a table with the same name as the column that was extracted, and adding a foreign key column called <code>tablename_id</code>.</p>
<p>You can specify a custom table name using <code>table=</code>, and a custom foreign key name using <code>fk_column=</code>. This example creates a table called <code>tree_species</code> and a foreign key column called <code>tree_species_id</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["Trees"].extract("Species", table="tree_species", fk_column="tree_species_id") # </span><span class="al">TODO</span><span class="co">: see https://github.com/simonw/sqlite-utils/issues/235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting schema looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"Trees"</span>].schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [Trees] (
   [id] INTEGER PRIMARY KEY,
   [TreeAddress] TEXT,
   [Species] TEXT
)</code></pre>
</div>
</div>
<p>You can also extract multiple columns into the same external table. Say for example you have a table like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>show_table(db[<span class="st">"Trees"</span>].rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<table class="table"><thead><tr><th>id</th><th>TreeAddress</th><th>CommonName</th><th>LatinName</th></tr></thead><tbody><tr><td>1</td><td>52 Vine St</td><td>Palm</td><td>Arecaceae</td></tr><tr><td>2</td><td>12 Draft St</td><td>Oak</td><td>Quercus</td></tr><tr><td>3</td><td>51 Dark Ave</td><td>Palm</td><td>Arecaceae</td></tr><tr><td>4</td><td>1252 Left St</td><td>Palm</td><td>Arecaceae</td></tr></tbody></table>
</div>
</div>
<p>You can pass <code>["CommonName", "LatinName"]</code> to <code>.extract()</code> to extract both of those columns:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["Trees"].extract(["CommonName", "LatinName"]) # </span><span class="al">TODO</span><span class="co">: see https://github.com/simonw/sqlite-utils/issues/235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This produces the following schema:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db.schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE "Trees" (
   [id] INTEGER PRIMARY KEY,
   [TreeAddress] TEXT,
   [CommonName] TEXT
, [LatinName] TEXT);</code></pre>
</div>
</div>
<p>The table name <code>CommonName_LatinName</code> is derived from the extract columns. You can use <code>table=</code> and <code>fk_column=</code> to specify custom names like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["Trees"].extract(["CommonName", "LatinName"], table="Species", fk_column="species_id") # </span><span class="al">TODO</span><span class="co">: see https://github.com/simonw/sqlite-utils/issues/235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This produces the following schema:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db.schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE "Trees" (
   [id] INTEGER PRIMARY KEY,
   [TreeAddress] TEXT,
   [CommonName] TEXT
, [LatinName] TEXT);</code></pre>
</div>
</div>
<p>You can use the <code>rename=</code> argument to rename columns in the lookup table. To create a <code>Species</code> table with columns called <code>name</code> and <code>latin</code> you can do this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["Trees"].extract(</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     ["CommonName", "LatinName"],</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     table="Species",</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     fk_column="species_id",</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     rename={"CommonName": "name", "LatinName": "latin"}</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ) # </span><span class="al">TODO</span><span class="co">: see https://github.com/simonw/sqlite-utils/issues/235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This produces a lookup table like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print(db["Species"].schema)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="setting-an-id-based-on-the-hash-of-the-row-contents" class="level2">
<h2 class="anchored" data-anchor-id="setting-an-id-based-on-the-hash-of-the-row-contents">Setting an ID based on the hash of the row contents</h2>
<p>Sometimes you will find yourself working with a dataset that includes rows that do not have a provided obvious ID, but where you would like to assign one so that you can later upsert into that table without creating duplicate records.</p>
<p>In these cases, a useful technique is to create an ID that is derived from the sha1 hash of the row contents.</p>
<p><code>sqlite-utils</code> can do this for you using the <code>hash_id=</code> option. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>dogs <span class="op">=</span> db[<span class="st">"dogs"</span>].upsert({<span class="st">"name"</span>: <span class="st">"Cleo"</span>, <span class="st">"twitter"</span>: <span class="st">"cleopaws"</span>}, hash_id<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">list</span>(db[<span class="st">"dogs"</span>].rows))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[{'id': 'f501265970505d9825d8d9f590bfab3519fb20b1', 'name': 'Cleo', 'twitter': 'cleopaws'}]</code></pre>
</div>
</div>
<p>If you are going to use that ID straight away, you can access it using <code>last_pk</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>dogs.last_pk</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'f501265970505d9825d8d9f590bfab3519fb20b1'</code></pre>
</div>
</div>
<p>The hash will be created using all of the column values. To create a hash using a subset of the columns, pass the <code>hash_id_columns=</code> parameter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].upsert(</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"name"</span>: <span class="st">"Cleo"</span>, <span class="st">"twitter"</span>: <span class="st">"cleopaws"</span>, <span class="st">"age"</span>: <span class="dv">7</span>},</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    hash_id_columns<span class="op">=</span>(<span class="st">"name"</span>, <span class="st">"twitter"</span>)</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>hash_id=</code> parameter is optional if you specify <code>hash_id_columns=</code> - it will default to putting the hash in a column called <code>id</code>.</p>
<p>You can manually calculate these hashes using the <code>hash_record(record,</code> utility function.</p>
</section>
<section id="creating-views" class="level2">
<h2 class="anchored" data-anchor-id="creating-views">Creating views</h2>
<p>The <code>.create_view()</code> method on the database class can be used to create a view:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>db.create_view(<span class="st">"good_dogs"</span>, <span class="st">"""</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a><span class="st">    select * from dogs where is_good_dog = 1</span></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will raise a <code>sqlite_utils.utils.OperationalError</code> if a view with that name already exists.</p>
<p>You can pass <code>ignore=True</code> to silently ignore an existing view and do nothing, or <code>replace=True</code> to replace an existing view with a new definition if your select statement differs from the current view:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>db.create_view(<span class="st">"good_dogs"</span>, <span class="st">"""</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="st">    select * from dogs where is_good_dog = 1</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>, replace<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="storing-json" class="level2">
<h2 class="anchored" data-anchor-id="storing-json">Storing JSON</h2>
<p>SQLite has <a href="https://www.sqlite.org/json1.html">excellent JSON support</a>, and <code>sqlite-utils</code> can help you take advantage of this: if you attempt to insert a value that can be represented as a JSON list or dictionary, <code>sqlite-utils</code> will create TEXT column and store your data as serialized JSON. This means you can quickly store even complex data structures in SQLite and query them using JSON features.</p>
<p>For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"niche_museums"</span>].insert({</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"The Bigfoot Discovery Museum"</span>,</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"url"</span>: <span class="st">"http://bigfootdiscoveryproject.com/"</span>,</span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hours"</span>: {</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Monday"</span>: [<span class="dv">11</span>, <span class="dv">18</span>],</span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Wednesday"</span>: [<span class="dv">11</span>, <span class="dv">18</span>],</span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Thursday"</span>: [<span class="dv">11</span>, <span class="dv">18</span>],</span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Friday"</span>: [<span class="dv">11</span>, <span class="dv">18</span>],</span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Saturday"</span>: [<span class="dv">11</span>, <span class="dv">18</span>],</span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Sunday"</span>: [<span class="dv">11</span>, <span class="dv">18</span>]</span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"address"</span>: {</span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"streetAddress"</span>: <span class="st">"5497 Highway 9"</span>,</span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"addressLocality"</span>: <span class="st">"Felton, CA"</span>,</span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"postalCode"</span>: <span class="st">"95018"</span></span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a>db.execute(<span class="st">"""</span></span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a><span class="st">    select json_extract(address, '$.addressLocality')</span></span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a><span class="st">    from niche_museums</span></span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>).fetchall()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[('Felton, CA',)]</code></pre>
</div>
</div>
</section>
<section id="converting-column-values-using-sql-functions" class="level2">
<h2 class="anchored" data-anchor-id="converting-column-values-using-sql-functions">Converting column values using SQL functions</h2>
<p>Sometimes it can be useful to run values through a SQL function prior to inserting them. A simple example might be converting a value to upper case while it is being inserted.</p>
<p>The <code>conversions={...}</code> parameter can be used to specify custom SQL to be used as part of a <code>INSERT</code> or <code>UPDATE</code> SQL statement.</p>
<p>You can specify an upper case conversion for a specific column like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"example"</span>].insert({</span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"The Bigfoot Discovery Museum"</span></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>}, conversions<span class="op">=</span>{<span class="st">"name"</span>: <span class="st">"upper(?)"</span>})</span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(db[<span class="st">"example"</span>].rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'name': 'THE BIGFOOT DISCOVERY MUSEUM'}]</code></pre>
</div>
</div>
<p>The dictionary key is the column name to be converted. The value is the SQL fragment to use, with a <code>?</code> placeholder for the original value.</p>
<p>A more useful example: if you are working with <a href="https://www.gaia-gis.it/fossil/libspatialite/index">SpatiaLite</a> you may find yourself wanting to create geometry values from a WKT value. Code to do that could look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> shape</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> httpx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="co"># db = Database("../test/places.db")</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a><span class="co"># # Initialize SpatiaLite</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a><span class="co"># db.init_spatialite()</span></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Use sqlite-utils to create a places table</span></span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a><span class="co"># places = db["places"].create({"id": int, "name": str})</span></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a><span class="co"># # Add a SpatiaLite 'geometry' column</span></span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a><span class="co"># places.add_geometry_column("geometry", "MULTIPOLYGON")</span></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a><span class="co"># # Fetch some GeoJSON from Who's On First:</span></span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a><span class="co"># geojson = httpx.get(</span></span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     "https://raw.githubusercontent.com/whosonfirst-data/"</span></span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     "whosonfirst-data-admin-gb/master/data/404/227/475/404227475.geojson"</span></span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ).json()</span></span>
<span id="cb196-16"><a href="#cb196-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-17"><a href="#cb196-17" aria-hidden="true" tabindex="-1"></a><span class="co"># # Convert to "Well Known Text" format using shapely</span></span>
<span id="cb196-18"><a href="#cb196-18" aria-hidden="true" tabindex="-1"></a><span class="co"># wkt = shape(geojson["geometry"]).wkt</span></span>
<span id="cb196-19"><a href="#cb196-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-20"><a href="#cb196-20" aria-hidden="true" tabindex="-1"></a><span class="co"># # Insert the record, converting the WKT to a SpatiaLite geometry:</span></span>
<span id="cb196-21"><a href="#cb196-21" aria-hidden="true" tabindex="-1"></a><span class="co"># db["places"].insert(</span></span>
<span id="cb196-22"><a href="#cb196-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     {"name": "Wales", "geometry": wkt},</span></span>
<span id="cb196-23"><a href="#cb196-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     conversions={"geometry": "GeomFromText(?, 4326)"},</span></span>
<span id="cb196-24"><a href="#cb196-24" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This example uses gographical data from <a href="https://whosonfirst.org/">Who’s On First</a> and depends on the <a href="https://shapely.readthedocs.io/en/stable/manual.html">Shapely</a> and <a href="https://www.python-httpx.org/">HTTPX</a> Python libraries.</p>
</section>
<section id="checking-the-sqlite-version" class="level2">
<h2 class="anchored" data-anchor-id="checking-the-sqlite-version">Checking the SQLite version</h2>
<p>The <code>db.sqlite_version</code> property returns a tuple of integers representing the version of SQLite used for that database object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>db.sqlite_version</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(3, 37, 0)</code></pre>
</div>
</div>
</section>
<section id="introspecting-tables-and-views" class="level2">
<h2 class="anchored" data-anchor-id="introspecting-tables-and-views">Introspecting tables and views</h2>
<p>If you have loaded an existing table or view, you can use introspection to find out more about it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Table Trees (id, TreeAddress, CommonName, LatinName)&gt;</code></pre>
</div>
</div>
<section id="exists" class="level3">
<h3 class="anchored" data-anchor-id="exists">.exists()</h3>
<p>The <code>.exists()</code> method can be used to find out if a table exists or not:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].exists()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees2"</span>].exists()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>False</code></pre>
</div>
</div>
</section>
<section id="count" class="level3">
<h3 class="anchored" data-anchor-id="count">.count</h3>
<p>The <code>.count</code> property shows the current number of rows (<code>select count(*) from table</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>4</code></pre>
</div>
</div>
<p>This property will take advantage of <code>python_api_cached_table_counts</code> if the <code>use_counts_table</code> property is set on the database. You can avoid that optimization entirely by calling <code>table.count_where()</code> instead of accessing the property.</p>
</section>
<section id="columns" class="level3">
<h3 class="anchored" data-anchor-id="columns">.columns</h3>
<p>The <code>.columns</code> property shows the columns in the table or view. It returns a list of <code>Column(cid, name, type, notnull, default_value, is_pk)</code> named tuples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[Column(cid=0, name='id', type='INTEGER', notnull=0, default_value=None, is_pk=1),
 Column(cid=1, name='TreeAddress', type='TEXT', notnull=0, default_value=None, is_pk=0),
 Column(cid=2, name='CommonName', type='TEXT', notnull=0, default_value=None, is_pk=0),
 Column(cid=3, name='LatinName', type='TEXT', notnull=0, default_value=None, is_pk=0)]</code></pre>
</div>
</div>
</section>
<section id="columns_dict" class="level3">
<h3 class="anchored" data-anchor-id="columns_dict">.columns_dict</h3>
<p>The <code>.columns_dict</code> property returns a dictionary version of the columns with just the names and Python types:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].columns_dict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'id': int, 'TreeAddress': str, 'CommonName': str, 'LatinName': str}</code></pre>
</div>
</div>
</section>
<section id="pks" class="level3">
<h3 class="anchored" data-anchor-id="pks">.pks</h3>
<p>The <code>.pks</code> property returns a list of strings naming the primary key columns for the table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].pks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['id']</code></pre>
</div>
</div>
<p>If a table has no primary keys but is a <a href="https://www.sqlite.org/rowidtable.html">rowid table</a>, this property will return <code>['rowid']</code>.</p>
</section>
<section id="use_rowid" class="level3">
<h3 class="anchored" data-anchor-id="use_rowid">.use_rowid</h3>
<p>Almost all SQLite tables have a <code>rowid</code> column, but a table with no explicitly defined primary keys must use that <code>rowid</code> as the primary key for identifying individual rows. The <code>.use_rowid</code> property checks to see if a table needs to use the <code>rowid</code> in this way - it returns <code>True</code> if the table has no explicitly defined primary keys and <code>False</code> otherwise.</p>
</section>
<section id="foreign_keys" class="level3">
<h3 class="anchored" data-anchor-id="foreign_keys">.foreign_keys</h3>
<p>The <code>.foreign_keys</code> property returns any foreign key relationships for the table, as a list of <code>ForeignKey(table, column, other_table, other_column)</code> named tuples. It is not available on views.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].foreign_keys</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[]</code></pre>
</div>
</div>
</section>
<section id="schema" class="level3">
<h3 class="anchored" data-anchor-id="schema">.schema</h3>
<p>The <code>.schema</code> property outputs the table’s schema as a SQL string:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"Trees"</span>].schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE "Trees" (
   [id] INTEGER PRIMARY KEY,
   [TreeAddress] TEXT,
   [CommonName] TEXT
, [LatinName] TEXT)</code></pre>
</div>
</div>
</section>
<section id="strict" class="level3">
<h3 class="anchored" data-anchor-id="strict">.strict</h3>
<p>The <code>.strict</code> property identifies if the table is a <a href="https://www.sqlite.org/stricttables.html">SQLite STRICT table</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].strict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>False</code></pre>
</div>
</div>
</section>
<section id="indexes" class="level3">
<h3 class="anchored" data-anchor-id="indexes">.indexes</h3>
<p>The <code>.indexes</code> property returns all indexes created for a table, as a list of <code>Index(seq, name, unique, origin, partial, columns)</code> named tuples. It is not available on views.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].indexes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[]</code></pre>
</div>
</div>
</section>
<section id="xindexes" class="level3">
<h3 class="anchored" data-anchor-id="xindexes">.xindexes</h3>
<p>The <code>.xindexes</code> property returns more detailed information about the indexes on the table, using the SQLite <a href="https://sqlite.org/pragma.html#pragma_index_xinfo">PRAGMA index_xinfo()</a> mechanism. It returns a list of <code>XIndex(name, columns)</code> named tuples, where <code>columns</code> is a list of <code>XIndexColumn(seqno, cid, name, desc, coll, key)</code> named tuples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].xindexes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[]</code></pre>
</div>
</div>
</section>
<section id="triggers" class="level3">
<h3 class="anchored" data-anchor-id="triggers">.triggers</h3>
<p>The <code>.triggers</code> property lists database triggers. It can be used on both database and table objects. It returns a list of <code>Trigger(name, table, sql)</code> named tuples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].triggers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[]</code></pre>
</div>
</div>
</section>
<section id="triggers_dict" class="level3">
<h3 class="anchored" data-anchor-id="triggers_dict">.triggers_dict</h3>
<p>The <code>.triggers_dict</code> property returns the triggers for that table as a dictionary mapping their names to their SQL definitions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].enable_counts()</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].triggers_dict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'Trees_counts_insert': "CREATE TRIGGER [Trees_counts_insert] AFTER INSERT ON [Trees]\nBEGIN\n    INSERT OR REPLACE INTO [_counts]\n    VALUES (\n        'Trees',\n        COALESCE(\n            (SELECT count FROM [_counts] WHERE [table] = 'Trees'),\n        0\n        ) + 1\n    );\nEND",
 'Trees_counts_delete': "CREATE TRIGGER [Trees_counts_delete] AFTER DELETE ON [Trees]\nBEGIN\n    INSERT OR REPLACE INTO [_counts]\n    VALUES (\n        'Trees',\n        COALESCE(\n            (SELECT count FROM [_counts] WHERE [table] = 'Trees'),\n        0\n        ) - 1\n    );\nEND"}</code></pre>
</div>
</div>
<p>The same property exists on the database, and will return all triggers across all tables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>db.triggers_dict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'Trees_counts_insert': "CREATE TRIGGER [Trees_counts_insert] AFTER INSERT ON [Trees]\nBEGIN\n    INSERT OR REPLACE INTO [_counts]\n    VALUES (\n        'Trees',\n        COALESCE(\n            (SELECT count FROM [_counts] WHERE [table] = 'Trees'),\n        0\n        ) + 1\n    );\nEND",
 'Trees_counts_delete': "CREATE TRIGGER [Trees_counts_delete] AFTER DELETE ON [Trees]\nBEGIN\n    INSERT OR REPLACE INTO [_counts]\n    VALUES (\n        'Trees',\n        COALESCE(\n            (SELECT count FROM [_counts] WHERE [table] = 'Trees'),\n        0\n        ) - 1\n    );\nEND"}</code></pre>
</div>
</div>
</section>
<section id="detect_fts" class="level3">
<h3 class="anchored" data-anchor-id="detect_fts">.detect_fts()</h3>
<p>The <code>detect_fts()</code> method returns the associated SQLite FTS table name, if one exists for this table. If the table has not been configured for full-text search it returns <code>None</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].detect_fts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'Trees_fts'</code></pre>
</div>
</div>
</section>
<section id="virtual_table_using" class="level3">
<h3 class="anchored" data-anchor-id="virtual_table_using">.virtual_table_using</h3>
<p>The <code>.virtual_table_using</code> property reveals if a table is a virtual table. It returns <code>None</code> for regular tables and the upper case version of the type of virtual table otherwise. For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].enable_fts([<span class="st">"TreeAddress"</span>])</span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees_fts"</span>].virtual_table_using</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'FTS5'</code></pre>
</div>
</div>
</section>
<section id="has_counts_triggers" class="level3">
<h3 class="anchored" data-anchor-id="has_counts_triggers">.has_counts_triggers</h3>
<p>The <code>.has_counts_triggers</code> property shows if a table has been configured with triggers for updating a <code>_counts</code> table, as described in <code>python_api_cached_table_counts</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].has_counts_triggers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>False</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].enable_counts()</span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"Trees"</span>].has_counts_triggers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
</section>
</section>
<section id="full-text-search" class="level2">
<h2 class="anchored" data-anchor-id="full-text-search">Full-text search</h2>
<p>SQLite includes bundled extensions that implement <a href="https://www.sqlite.org/fts5.html">powerful full-text search</a>.</p>
<section id="enabling-full-text-search-for-a-table" class="level3">
<h3 class="anchored" data-anchor-id="enabling-full-text-search-for-a-table">Enabling full-text search for a table</h3>
<p>You can enable full-text search on a table using <code>.enable_fts(columns)</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].enable_fts([<span class="st">"name"</span>, <span class="st">"twitter"</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can then run searches using the <code>.search()</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> <span class="bu">list</span>(db[<span class="st">"dogs"</span>].search(<span class="st">"cleo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This method returns a generator that can be looped over to get dictionaries for each row, similar to <code>python_api_rows</code>.</p>
<p>If you insert additional records into the table you will need to refresh the search index using <code>populate_fts()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].insert({</span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">2</span>,</span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Marnie"</span>,</span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"twitter"</span>: <span class="st">"MarnieTheDog"</span>,</span>
<span id="cb239-5"><a href="#cb239-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>: <span class="dv">16</span>,</span>
<span id="cb239-6"><a href="#cb239-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"is_good_dog"</span>: <span class="va">True</span>,</span>
<span id="cb239-7"><a href="#cb239-7" aria-hidden="true" tabindex="-1"></a>}, pk<span class="op">=</span><span class="st">"id"</span>)</span>
<span id="cb239-8"><a href="#cb239-8" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].populate_fts([<span class="st">"name"</span>, <span class="st">"twitter"</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A better solution is to use database triggers. You can set up database triggers to automatically update the full-text index using <code>create_triggers=True</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].enable_fts([<span class="st">"name"</span>, <span class="st">"twitter"</span>], create_triggers<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Table dogs (id, age, name, twitter, is_good_dog)&gt;</code></pre>
</div>
</div>
<p><code>.enable_fts()</code> defaults to using <a href="https://www.sqlite.org/fts5.html">FTS5</a>. If you wish to use <a href="https://www.sqlite.org/fts3.html">FTS4</a> instead, use the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].enable_fts([<span class="st">"name"</span>, <span class="st">"twitter"</span>], fts_version<span class="op">=</span><span class="st">"FTS4"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Table dogs (id, age, name, twitter, is_good_dog)&gt;</code></pre>
</div>
</div>
<p>You can customize the tokenizer configured for the table using the <code>tokenize=</code> parameter. For example, to enable Porter stemming, where English words like “running” will match stemmed alternatives such as “run”, use <code>tokenize="porter"</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["articles"].enable_fts(["headline", "body"], tokenize="porter") # </span><span class="al">TODO</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The SQLite documentation has more on <a href="https://www.sqlite.org/fts5.html#tokenizers">FTS5 tokenizers</a> and <a href="https://www.sqlite.org/fts3.html#tokenizer">FTS4 tokenizers</a>. <code>porter</code> is a valid option for both.</p>
<p>If you attempt to configure a FTS table where one already exists, a <code>sqlite3.OperationalError</code> exception will be raised.</p>
<p>You can replace the existing table with a new configuration using <code>replace=True</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["articles"].enable_fts(["headline"], tokenize="porter", replace=True) # </span><span class="al">TODO</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will have no effect if the FTS table already exists, otherwise it will drop and recreate the table with the new settings. This takes into consideration the columns, the tokenizer, the FTS version used and whether or not the table has triggers.</p>
<p>To remove the FTS tables and triggers you created, use the <code>disable_fts()</code> table method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].disable_fts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Table dogs (id, age, name, twitter, is_good_dog)&gt;</code></pre>
</div>
</div>
</section>
<section id="quoting-characters-for-use-in-search" class="level3">
<h3 class="anchored" data-anchor-id="quoting-characters-for-use-in-search">Quoting characters for use in search</h3>
<p>SQLite supports <a href="https://www.sqlite.org/fts3.html#full_text_index_queries">advanced search query syntax</a>. In some situations you may wish to disable this, since characters such as <code>.</code> may have special meaning that causes errors when searching for strings provided by your users.</p>
<p>The <code>db.quote_fts(query)</code> method returns the query with SQLite full-text search quoting applied such that the query should be safe to use in a search:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>db.quote_fts(<span class="st">"Search term."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'"Search" "term."'</code></pre>
</div>
</div>
</section>
<section id="searching-with-table.search" class="level3">
<h3 class="anchored" data-anchor-id="searching-with-table.search">Searching with table.search()</h3>
<p>The <code>table.search(q)</code> method returns a generator over Python dictionaries representing rows that match the search phrase <code>q</code>, ordered by relevance with the most relevant results first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span></span>
<span id="cb250-2"><a href="#cb250-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for article in db["articles"].search("jquery"):</span></span>
<span id="cb250-3"><a href="#cb250-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(article)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>.search()</code> method also accepts the following optional parameters:</p>
<p>The column to sort by. Defaults to relevance score. Can optionally include a <code>desc</code>, e.g.&nbsp;<code>rowid desc</code>.</p>
<p>Columns to return. Defaults to all columns.</p>
<p>Number of results to return. Defaults to all results.</p>
<p>Offset to use along side the limit parameter.</p>
<p>Extra SQL fragment for the WHERE clause</p>
<p>Arguments to use for <code>:param</code> placeholders in the extra WHERE clause</p>
<p>Apply <a href="https://sqlite-utils.datasette.io/en/stable/python-api.html#python-api-quote-fts">FTS quoting rules</a> to the search query, disabling advanced query syntax in a way that avoids surprising errors.</p>
<p>To return just the title and published columns for three matches for <code>"dog"</code> where the <code>id</code> is greater than 10 ordered by <code>published</code> with the most recent first, use the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for article in db["articles"].search(</span></span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     "dog",</span></span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     order_by="published desc",</span></span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     limit=3,</span></span>
<span id="cb251-6"><a href="#cb251-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     where="id &gt; :min_id",</span></span>
<span id="cb251-7"><a href="#cb251-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     where_args={"min_id": 10},</span></span>
<span id="cb251-8"><a href="#cb251-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     columns=["title", "published"]</span></span>
<span id="cb251-9"><a href="#cb251-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ):</span></span>
<span id="cb251-10"><a href="#cb251-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(article)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="building-sql-queries-with-table.search_sql" class="level3">
<h3 class="anchored" data-anchor-id="building-sql-queries-with-table.search_sql">Building SQL queries with table.search_sql()</h3>
<p>You can generate the SQL query that would be used for a search using the <code>table.search_sql()</code> method. It takes the same arguments as <code>table.search()</code>, with the exception of the search query and the <code>where_args</code> parameter, since those should be provided when the returned SQL is executed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a><span class="co"># print(db["articles"].search_sql(columns=["title", "author"]))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Outputs:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span> original <span class="kw">as</span> (</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">rowid</span>,</span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a>        [title],</span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>        [author]</span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">from</span> [articles]</span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a>    [original].[title],</span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a>    [original].[author]</span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span></span>
<span id="cb253-12"><a href="#cb253-12" aria-hidden="true" tabindex="-1"></a>    [original]</span>
<span id="cb253-13"><a href="#cb253-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">join</span> [articles_fts] <span class="kw">on</span> [original].<span class="dt">rowid</span> <span class="op">=</span> [articles_fts].<span class="dt">rowid</span></span>
<span id="cb253-14"><a href="#cb253-14" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span></span>
<span id="cb253-15"><a href="#cb253-15" aria-hidden="true" tabindex="-1"></a>    [articles_fts] match <span class="ch">:query</span></span>
<span id="cb253-16"><a href="#cb253-16" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span></span>
<span id="cb253-17"><a href="#cb253-17" aria-hidden="true" tabindex="-1"></a>    [articles_fts].<span class="fu">rank</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This method detects if a SQLite table uses FTS4 or FTS5, and outputs the correct SQL for ordering by relevance depending on the search type.</p>
<p>The FTS4 output looks something like this:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="kw">with</span> original <span class="kw">as</span> (</span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">rowid</span>,</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>        [title],</span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>        [author]</span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">from</span> [articles]</span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a>    [original].[title],</span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a>    [original].[author]</span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span></span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a>    [original]</span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">join</span> [articles_fts] <span class="kw">on</span> [original].<span class="dt">rowid</span> <span class="op">=</span> [articles_fts].<span class="dt">rowid</span></span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a><span class="kw">where</span></span>
<span id="cb254-15"><a href="#cb254-15" aria-hidden="true" tabindex="-1"></a>    [articles_fts] match <span class="ch">:query</span></span>
<span id="cb254-16"><a href="#cb254-16" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span></span>
<span id="cb254-17"><a href="#cb254-17" aria-hidden="true" tabindex="-1"></a>    rank_bm25(matchinfo([articles_fts], <span class="st">'pcnalx'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This uses the <code>rank_bm25()</code> custom SQL function from <a href="https://github.com/simonw/sqlite-fts4">sqlite-fts4</a>. You can register that custom function against a <code>Database</code> connection using this method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>db.register_fts4_bm25()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="rebuilding-a-full-text-search-table" class="level2">
<h2 class="anchored" data-anchor-id="rebuilding-a-full-text-search-table">Rebuilding a full-text search table</h2>
<p>You can rebuild a table using the <code>table.rebuild_fts()</code> method. This is useful for if the table configuration changes or the indexed data has become corrupted in some way.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["dogs"].rebuild_fts() # </span><span class="al">TODO</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This method can be called on a table that has been configured for full-text search - <code>dogs</code> in this instance - or directly on a <code>_fts</code> table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="co"># db["dogs_fts"].rebuild_fts() # </span><span class="al">TODO</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This runs the following SQL:</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> dogs_fts (dogs_fts) <span class="kw">VALUES</span> (<span class="ot">"rebuild"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="optimizing-a-full-text-search-table" class="level2">
<h2 class="anchored" data-anchor-id="optimizing-a-full-text-search-table">Optimizing a full-text search table</h2>
<p>Once you have populated a FTS table you can optimize it to dramatically reduce its size like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].optimize()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This runs the following SQL:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> dogs_fts (dogs_fts) <span class="kw">VALUES</span> (<span class="ot">"optimize"</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="cached-table-counts-using-triggers" class="level2">
<h2 class="anchored" data-anchor-id="cached-table-counts-using-triggers">Cached table counts using triggers</h2>
<p>The <code>select count(*)</code> query in SQLite requires a full scan of the primary key index, and can take an increasingly long time as the table grows larger.</p>
<p>The <code>table.enable_counts()</code> method can be used to configure triggers to continuously update a record in a <code>_counts</code> table. This value can then be used to quickly retrieve the count of rows in the associated table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].enable_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will create the <code>_counts</code> table if it does not already exist, with the following schema:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"_counts"</span>].schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [_counts](
   [table] TEXT PRIMARY KEY,
   count INTEGER DEFAULT 0
)</code></pre>
</div>
</div>
<p>You can enable cached counts for every table in a database (except for virtual tables and the <code>_counts</code> table itself) using the database <code>enable_counts()</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>db.enable_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once enabled, table counts will be stored in the <code>_counts</code> table. The count records will be automatically kept up-to-date by the triggers when rows are added or deleted to the table.</p>
<p>To access these counts you can query the <code>_counts</code> table directly or you can use the <code>db.cached_counts()</code> method. This method returns a dictionary mapping tables to their counts:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>db.cached_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'dogs': 2, 'compound_dogs': 1}</code></pre>
</div>
</div>
<p>You can pass a list of table names to this method to retrieve just those counts:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>db.cached_counts([<span class="st">"dogs"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'dogs': 2}</code></pre>
</div>
</div>
<p>The <code>table.count</code> property executes a <code>select count(*)</code> query by default, unless the <code>db.use_counts_table</code> property is set to <code>True</code>.</p>
<p>You can set <code>use_counts_table</code> to <code>True</code> when you instantiate the database object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(<span class="st">"../test/dogs.db"</span>, use_counts_table<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If the property is <code>True</code> any calls to the <code>table.count</code> property will first attempt to find the cached count in the <code>_counts</code> table, and fall back on a <code>count(*)</code> query if the value is not available or the table is missing.</p>
<p>Calling the <code>.enable_counts()</code> method on a database or table object will set <code>use_counts_table</code> to <code>True</code> for the lifetime of that database object.</p>
<p>If the <code>_counts</code> table ever becomes out-of-sync with the actual table counts you can repair it using the <code>.reset_counts()</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>db.reset_counts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-indexes" class="level2">
<h2 class="anchored" data-anchor-id="creating-indexes">Creating indexes</h2>
<p>You can create an index on a table using the <code>.create_index(columns)</code> method. The method takes a list of columns:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].create_index([<span class="st">"is_good_dog"</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By default the index will be named <code>idx_{table-name}_{columns}</code>. If you pass <code>find_unique_name=True</code> and the automatically derived name already exists, an available name will be found by incrementing a suffix number, for example <code>idx_items_title_2</code>.</p>
<p>You can customize the name of the created index by passing the <code>index_name</code> parameter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].create_index(</span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"is_good_dog"</span>, <span class="st">"age"</span>],</span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a>    index_name<span class="op">=</span><span class="st">"good_dogs_by_age"</span></span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To create an index in descending order for a column, wrap the column name in <code>db.DescIndex()</code> like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlite_utils.db <span class="im">import</span> DescIndex</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].create_index(</span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"is_good_dog"</span>, DescIndex(<span class="st">"age"</span>)],</span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a>    index_name<span class="op">=</span><span class="st">"good_dogs_by_age"</span></span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can create a unique index by passing <code>unique=True</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].create_index([<span class="st">"name"</span>], unique<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use <code>if_not_exists=True</code> to do nothing if an index with that name already exists.</p>
<p>Pass <code>analyze=True</code> to run <code>ANALYZE</code> against the new index after creating it.</p>
</section>
<section id="optimizing-index-usage-with-analyze" class="level2">
<h2 class="anchored" data-anchor-id="optimizing-index-usage-with-analyze">Optimizing index usage with ANALYZE</h2>
<p>The <a href="https://www.sqlite.org/lang_analyze.html">SQLite ANALYZE command</a> builds a table of statistics which the query planner can use to make better decisions about which indexes to use for a given query.</p>
<p>You should run <code>ANALYZE</code> if your database is large and you do not think your indexes are being efficiently used.</p>
<p>To run <code>ANALYZE</code> against every index in a database, use this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>db.analyze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To run it just against a specific named index, pass the name of the index to that method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a>db.analyze(<span class="st">"idx_dogs_name"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To run against all indexes attached to a specific table, you can either pass the table name to <code>db.analyze(...)</code> or you can call the method directly on the table, like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"dogs"</span>].analyze()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="vacuum" class="level2">
<h2 class="anchored" data-anchor-id="vacuum">Vacuum</h2>
<p>You can optimize your database by running VACUUM against it like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>Database(<span class="st">"../test/my_database.db"</span>).vacuum()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="wal-mode" class="level2">
<h2 class="anchored" data-anchor-id="wal-mode">WAL mode</h2>
<p>You can enable <a href="https://www.sqlite.org/wal.html">Write-Ahead Logging</a> for a database with <code>.enable_wal()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>Database(<span class="st">"../test/my_database.db"</span>).enable_wal()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can disable WAL mode using <code>.disable_wal()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a>Database(<span class="st">"../test/my_database.db"</span>).disable_wal()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can check the current journal mode for a database using the <code>journal_mode</code> property:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>journal_mode <span class="op">=</span> Database(<span class="st">"../test/my_database.db"</span>).journal_mode</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This will usually be <code>wal</code> or <code>delete</code> (meaning WAL is disabled), but can have other values - see the <a href="https://www.sqlite.org/pragma.html#pragma_journal_mode">PRAGMA journal_mode</a> documentation.</p>
</section>
<section id="suggesting-column-types" class="level2">
<h2 class="anchored" data-anchor-id="suggesting-column-types">Suggesting column types</h2>
<p>When you create a new table for a list of inserted or upserted Python dictionaries, those methods detect the correct types for the database columns based on the data you pass in.</p>
<p>In some situations you may need to intervene in this process, to customize the columns that are being created in some way - see <code>python_api_explicit_create</code>.</p>
<p>That table <code>.create()</code> method takes a dictionary mapping column names to the Python type they should store:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"cats"</span>].create({</span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="bu">int</span>,</span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="bu">str</span>,</span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"weight"</span>: <span class="bu">float</span>,</span>
<span id="cb283-6"><a href="#cb283-6" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can use the <code>suggest_column_types()</code> helper function to derive a dictionary of column names and types from a list of records, suitable to be passed to <code>table.create()</code>.</p>
<p>For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlite_utils <span class="im">import</span> suggest_column_types</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>cats <span class="op">=</span> [{</span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">1</span>,</span>
<span id="cb285-3"><a href="#cb285-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Snowflake"</span></span>
<span id="cb285-4"><a href="#cb285-4" aria-hidden="true" tabindex="-1"></a>}, {</span>
<span id="cb285-5"><a href="#cb285-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"id"</span>: <span class="dv">2</span>,</span>
<span id="cb285-6"><a href="#cb285-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"name"</span>: <span class="st">"Crabtree"</span>,</span>
<span id="cb285-7"><a href="#cb285-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>: <span class="dv">4</span></span>
<span id="cb285-8"><a href="#cb285-8" aria-hidden="true" tabindex="-1"></a>}]</span>
<span id="cb285-9"><a href="#cb285-9" aria-hidden="true" tabindex="-1"></a>types <span class="op">=</span> suggest_column_types(cats)</span>
<span id="cb285-10"><a href="#cb285-10" aria-hidden="true" tabindex="-1"></a>types</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'id': int, 'name': str, 'age': int}</code></pre>
</div>
</div>
<p>Manually add an extra field:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb287"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>types[<span class="st">"thumbnail"</span>] <span class="op">=</span> <span class="bu">bytes</span></span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>types</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>{'id': int, 'name': str, 'age': int, 'thumbnail': bytes}</code></pre>
</div>
</div>
<p>Create the table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb289"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"cats"</span>].create(types, pk<span class="op">=</span><span class="st">"id"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Table cats (id, name, age, thumbnail)&gt;</code></pre>
</div>
</div>
<p>Insert the records:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"cats"</span>].insert_all(cats)</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(db[<span class="st">"cats"</span>].rows)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'id': 1, 'name': 'Snowflake', 'age': None, 'thumbnail': None},
 {'id': 2, 'name': 'Crabtree', 'age': 4, 'thumbnail': None}]</code></pre>
</div>
</div>
<p>The table schema looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"cats"</span>].schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [cats] (
   [id] INTEGER PRIMARY KEY,
   [name] TEXT,
   [age] INTEGER,
   [thumbnail] BLOB
)</code></pre>
</div>
</div>
</section>
<section id="registering-custom-sql-functions" class="level2">
<h2 class="anchored" data-anchor-id="registering-custom-sql-functions">Registering custom SQL functions</h2>
<p>SQLite supports registering custom SQL functions written in Python. The <code>db.register_function()</code> method lets you register these functions, and keeps track of functions that have already been registered.</p>
<p>If you use it as a method it will automatically detect the name and number of arguments needed by the function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reverse_string(s):</span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">""</span>.join(<span class="bu">reversed</span>(<span class="bu">list</span>(s)))</span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a>db.register_function(reverse_string)</span>
<span id="cb295-7"><a href="#cb295-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db.execute(<span class="st">'select reverse_string("hello")'</span>).fetchone()[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>olleh</code></pre>
</div>
</div>
<p>You can also use the method as a function decorator like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb297"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="at">@db.register_function</span></span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reverse_string(s):</span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">""</span>.join(<span class="bu">reversed</span>(<span class="bu">list</span>(s)))</span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db.execute(<span class="st">'select reverse_string("hello")'</span>).fetchone()[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>olleh</code></pre>
</div>
</div>
<p>By default, the name of the Python function will be used as the name of the SQL function. You can customize this with the <code>name=</code> keyword argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb299"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="at">@db.register_function</span>(name<span class="op">=</span><span class="st">"rev"</span>)</span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reverse_string(s):</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">""</span>.join(<span class="bu">reversed</span>(<span class="bu">list</span>(s)))</span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db.execute(<span class="st">'select rev("hello")'</span>).fetchone()[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>olleh</code></pre>
</div>
</div>
<p>Python 3.8 added the ability to register <a href="https://sqlite.org/deterministic.html">deterministic SQLite functions</a>, allowing you to indicate that a function will return the exact same result for any given inputs and hence allowing SQLite to apply some performance optimizations. You can mark a function as deterministic using <code>deterministic=True</code>, like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb301"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="at">@db.register_function</span>(deterministic<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reverse_string(s):</span>
<span id="cb301-3"><a href="#cb301-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">""</span>.join(<span class="bu">reversed</span>(<span class="bu">list</span>(s)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you run this on a version of Python prior to 3.8 your code will still work, but the <code>deterministic=True</code> parameter will be ignored.</p>
<p>By default registering a function with the same name and number of arguments will have no effect - the <code>Database</code> instance keeps track of functions that have already been registered and skips registering them if <code>@db.register_function</code> is called a second time.</p>
<p>If you want to deliberately replace the registered function with a new implementation, use the <code>replace=True</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="at">@db.register_function</span>(deterministic<span class="op">=</span><span class="va">True</span>, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reverse_string(s):</span>
<span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s[::<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Exceptions that occur inside a user-defined function default to returning the following error:</p>
<pre><code>Unexpected error: user-defined function raised exception</code></pre>
<p>You can cause <code>sqlite3</code> to return more useful errors, including the traceback from the custom function, by executing the following before your custom functions are executed:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a>sqlite3.enable_callback_tracebacks(<span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="quoting-strings-for-use-in-sql" class="level2">
<h2 class="anchored" data-anchor-id="quoting-strings-for-use-in-sql">Quoting strings for use in SQL</h2>
<p>In almost all cases you should pass values to your SQL queries using the optional <code>parameters</code> argument to <code>db.query()</code>, as described in <code>python_api_parameters</code>.</p>
<p>If that option isn’t relevant to your use-case you can to quote a string for use with SQLite using the <code>db.quote()</code> method, like so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>db.quote(<span class="st">"hello"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>"'hello'"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb307"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a>db.quote(<span class="st">"hello'this'has'quotes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>"'hello''this''has''quotes'"</code></pre>
</div>
</div>
</section>
<section id="reading-rows-from-a-file" class="level2">
<h2 class="anchored" data-anchor-id="reading-rows-from-a-file">Reading rows from a file</h2>
<p>The <code>sqlite_utils.utils.rows_from_file()</code> helper function can read rows (a sequence of dictionaries) from CSV, TSV, JSON or newline-delimited JSON files.</p>
<p><em>Note: removed <code>autofunction:: sqlite_utils.utils.rows_from_file</code> here. We would use <code>show_doc</code>.</em></p>
</section>
<section id="setting-the-maximum-csv-field-size-limit" class="level2">
<h2 class="anchored" data-anchor-id="setting-the-maximum-csv-field-size-limit">Setting the maximum CSV field size limit</h2>
<p>Sometimes when working with CSV files that include extremely long fields you may see an error that looks like this:</p>
<pre><code>_csv.Error: field larger than field limit (131072)</code></pre>
<p>The Python standard library <code>csv</code> module enforces a field size limit. You can increase that limit using the <code>csv.field_size_limit(new_limit)</code> method (<a href="https://docs.python.org/3/library/csv.html#csv.field_size_limit">documented here</a>) but if you don’t want to pick a new level you may instead want to increase it to the maximum possible.</p>
<p>The maximum possible value for this is not documented, and varies between systems.</p>
<p>Calling <code>sqlite_utils.utils.maximize_csv_field_size_limit()</code> will set the value to the highest possible for the current system:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlite_utils.utils <span class="im">import</span> maximize_csv_field_size_limit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb311"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a>maximize_csv_field_size_limit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you need to reset to the original value after calling this function you can do so like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlite_utils.utils <span class="im">import</span> ORIGINAL_CSV_FIELD_SIZE_LIMIT</span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb313"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a>csv.field_size_limit(ORIGINAL_CSV_FIELD_SIZE_LIMIT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>9223372036854775807</code></pre>
</div>
</div>
</section>
<section id="detecting-column-types-using-typetracker" class="level2">
<h2 class="anchored" data-anchor-id="detecting-column-types-using-typetracker">Detecting column types using TypeTracker</h2>
<p>Sometimes you may find yourself working with data that lacks type information - data from a CSV file for example.</p>
<p>The <code>TypeTracker</code> class can be used to try to automatically identify the most likely types for data that is initially represented as strings.</p>
<p>Consider this example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb315"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv, io</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb316"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> io.StringIO(<span class="st">"id,name</span><span class="ch">\n</span><span class="st">1,Cleo</span><span class="ch">\n</span><span class="st">2,Cardi"</span>)</span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> <span class="bu">list</span>(csv.DictReader(csv_file))</span>
<span id="cb316-3"><a href="#cb316-3" aria-hidden="true" tabindex="-1"></a>rows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[{'id': '1', 'name': 'Cleo'}, {'id': '2', 'name': 'Cardi'}]</code></pre>
</div>
</div>
<p>If we insert this data directly into a table we will get a schema that is entirely <code>TEXT</code> columns:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb318"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> Database(memory<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"creatures"</span>].insert_all(rows)</span>
<span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db.schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE [creatures] (
   [id] TEXT,
   [name] TEXT
);</code></pre>
</div>
</div>
<p>We can detect the best column types using a <code>TypeTracker</code> instance:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb320"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlite_utils.utils <span class="im">import</span> TypeTracker</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb321"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a>tracker <span class="op">=</span> TypeTracker()</span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"creatures2"</span>].insert_all(tracker.wrap(rows))</span>
<span id="cb321-3"><a href="#cb321-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tracker.types)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'id': 'integer', 'name': 'text'}</code></pre>
</div>
</div>
<p>We can then apply those types to our new table using the <code>table.transform()</code> method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb323"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a>db[<span class="st">"creatures2"</span>].transform(types<span class="op">=</span>tracker.types)</span>
<span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(db[<span class="st">"creatures2"</span>].schema)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CREATE TABLE "creatures2" (
   [id] INTEGER,
   [name] TEXT
)</code></pre>
</div>
</div>
</section>
<section id="spatialite-helpers" class="level2">
<h2 class="anchored" data-anchor-id="spatialite-helpers">SpatiaLite helpers</h2>
<p><a href="https://www.gaia-gis.it/fossil/libspatialite/index">SpatiaLite</a> is a geographic extension to SQLite (similar to PostgreSQL + PostGIS). Using requires finding, loading and initializing the extension, adding geometry columns to existing tables and optionally creating spatial indexes. The utilities here help streamline that setup.</p>
<section id="initialize-spatialite" class="level3">
<h3 class="anchored" data-anchor-id="initialize-spatialite">Initialize SpatiaLite</h3>
<p><em>Note: removed <code>automethod:: sqlite_utils.db.Database.init_spatialite</code>. We would use <code>show_doc</code>.</em></p>
</section>
<section id="finding-spatialite" class="level3">
<h3 class="anchored" data-anchor-id="finding-spatialite">Finding SpatiaLite</h3>
<p><em>Note: removed <code>autofunction:: sqlite_utils.utils.find_spatialite</code>. We would use <code>show_doc</code>.</em></p>
</section>
<section id="adding-geometry-columns" class="level3">
<h3 class="anchored" data-anchor-id="adding-geometry-columns">Adding geometry columns</h3>
<p><em>Note: removed <code>autofunction:: sqlite_utils.db.Table.add_geometry_column</code>. We would use <code>show_doc</code>.</em></p>
</section>
<section id="creating-a-spatial-index" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-spatial-index">Creating a spatial index</h3>
<p><em>Note: removed <code>autofunction:: sqlite_utils.db.Table.create_spatial_index</code>. We would use <code>show_doc</code>.</em></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>